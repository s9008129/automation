# 功能規格：數位課程自動學習測驗代理人

**功能分支**: `001-elearn-skill`  
**建立日期**: 2026-01-11  
**最後更新**: 2026-02-08  
**狀態**: E2E 驗證完成（Phase 13.3 — 自動上課 ✅ 自動考試 ✅ 自動問卷 ✅）  
**輸入**: 系統升級計劃 v3.1 - 語意驅動 Playwright 自動化網頁代理服務

> **專案定位**：elearn-skill 是一個「數位課程自動學習測驗代理人」——獨立運作的自動化系統。  
> **三大核心代理功能**：自動課程影片閱讀、自動考試測驗、自動問卷填寫。  
> **設計原則**：決策與執行分離（AI=大腦、工具=手）、狀態外部化、事件驅動、可觀測性。  
> **技術核心**：Copilot SDK（gpt-5-mini）+ Playwright MCP + Telegram Bot 遠端操控。

---

## Clarifications

### Session 2026-01-11

- Q: 效能與資源限制應如何定義？ → A: 基於 Mac Pro M4 + 48GB 統一記憶體，elearn-skill 本身記憶體限制 2GB，LLM 推論延遲 p95 < 120 秒
- Q: LLM 連線失敗時的處理策略？ → A: 立即提示用戶「LLM 連線失敗」，終止自動化流程讓用戶人工查修

### Session 2026-01-17

- Q: 我看不懂 lint 失敗訊息怎麼辦？ → A: 以「人話」解釋錯誤原因與需要採取的動作（見人機協作操作指引）。
- Q: browser_snapshot 是截圖嗎？ → A: 不是，它回傳的是語意結構與 ref，方便 AI 點擊元素。
- Q: Copilot CLI 能否自動完成素材交付？ → A: 可自動取得 ARIA 快照，但 Codegen 仍需你手動操作一次。
- Q: e等公務園影片來源多元、頁面樣式不一，如何理解風險？ → A: 視為高機率 iframe 或跨域播放器，需在素材備註中回報。

---

## 使用者情境與測試 *(必要)*

### User Story 1 - 自動上課完成學習時數 (Priority: P1)

作為一位需要完成數位學習時數的公務人員，我希望系統能在我登入後自動播放課程影片並監控學習進度，讓我不需要手動操作就能達到規定的學習時數。

**為什麼此優先級**：上課是所有流程的基礎，必須先完成課程才能進行考試和問卷。這是用戶最耗時的任務，自動化效益最高。

**獨立測試**：可透過選擇一門 60 分鐘課程，驗證系統能自動播放至時數達標後停止，並正確更新進度記錄。

**驗收情境**：

1. **Given** 用戶已手動登入 elearn 平台，**When** 執行上課指令，**Then** 系統自動導航至課程清單並顯示未完成課程列表
2. **Given** 系統已識別出未完成課程，**When** 開始自動上課，**Then** 系統進入課程頁面並自動播放影片
3. **Given** 課程影片正在播放，**When** 學習時數達到規定時間（含 5% 緩衝），**Then** 系統自動退出課程並回到課程清單
4. **Given** 課程中途被中斷（用戶手動停止或系統異常），**When** 下次執行時，**Then** 系統從上次進度繼續播放

---

### User Story 2 - 自動登入與 Agent 接手 (Priority: P1)

作為一位需要遠端操控的公務人員，我希望系統能自動完成 eCPA 帳密登入，不需要手動操作電腦。

**為什麼此優先級**：這是所有自動化流程的前提，且是 Telegram 遠端操控的必要條件。

**獨立測試**：設定 .env 帳密後，執行自動登入模組，驗證自動登入成功並儲存狀態。

**驗收情境**：

1. **Given** .env 已設定 ECPA_ACCOUNT 和 ECPA_PASSWORD，**When** 系統執行自動登入，**Then** 自動導航至 eCPA 登入頁面、輸入帳密、完成登入
2. **Given** 登入狀態已儲存（auth.json），**When** 用戶執行自動化指令，**Then** 系統先嘗試載入已儲存狀態（快速路徑）
3. **Given** 已儲存的登入狀態已過期，**When** 系統嘗試使用，**Then** 自動重新執行帳密登入（慢速路徑）
4. **Given** 帳密未設定或登入失敗，**When** 系統嘗試登入，**Then** 回傳明確錯誤訊息給使用者

---

### User Story 3 - 自動考試並通過測驗 (Priority: P2)

作為一位完成課程學習的公務人員，我希望系統能自動完成課後測驗，並在未通過時自動重考直到通過。

**為什麼此優先級**：考試是課程完成的必要條件，但依賴 User Story 1 先完成課程。透過 Copilot SDK（gpt-5-mini）進行 AI 推論答題。

**獨立測試**：可選擇一門已完成上課的課程，驗證系統能爬取題目、送往 Copilot SDK 代理推論、選擇答案、送出並判讀結果。

**驗收情境**：

1. **Given** 用戶已完成課程學習，**When** 執行考試指令，**Then** 系統自動導航至考試頁面並開始測驗
2. **Given** 考試頁面已載入，**When** 系統擷取題目，**Then** 正確識別題目類型（單選/複選/是非）、題目內容與所有選項
3. **Given** 題目已擷取，**When** 送往 Copilot SDK 代理推論，**Then** 在 120 秒內返回答案選項
4. **Given** AI 連線失敗或推論逾時，**When** 系統偵測到錯誤，**Then** 立即提示用戶「AI 連線失敗」並終止自動化流程
5. **Given** 已取得答案，**When** 系統選擇答案並送出，**Then** 正確點選對應的選項並提交考卷（包含是非題）
6. **Given** 考試未通過（分數低於及格標準），**When** 系統偵測到未通過，**Then** 自動重新測驗（最多 5 次）

---

### User Story 4 - 進度儲存與恢復 (Priority: P2)

作為一位需要分天完成學習的公務人員，我希望系統能記住已完成的進度，讓我每次執行時從上次中斷的地方繼續。

**為什麼此優先級**：分天作業是核心使用情境。沒有此功能，用戶每次都需要重新開始。

**獨立測試**：可執行上課流程至一半後中斷，驗證進度已儲存；再次執行時驗證從正確的進度點繼續。

**驗收情境**：

1. **Given** 用戶完成一門課程的學習，**When** 系統更新狀態，**Then** 進度記錄自動儲存至本地檔案
2. **Given** 用戶中途中斷執行，**When** 下次執行同一指令，**Then** 系統自動讀取進度記錄並從中斷點繼續
3. **Given** 登入 Session 已過期，**When** 用戶執行任何指令，**Then** 系統提示用戶重新登入

---

### User Story 5 - 自動填寫問卷 (Priority: P3)

作為一位通過測驗的公務人員，我希望系統能自動填寫課後滿意度問卷，讓我不需要逐題點選。

**為什麼此優先級**：問卷是課程完成的最後一步，相對簡單但仍需自動化。問卷通常會開啟新頁籤，需要特殊處理。

**獨立測試**：可選擇一門已通過考試的課程，驗證系統能正確處理新頁籤、填寫所有選項、送出問卷。

**驗收情境**：

1. **Given** 用戶已通過課程測驗，**When** 執行問卷指令，**Then** 系統自動導航至問卷入口
2. **Given** 問卷連結開啟新頁籤，**When** 系統偵測到新頁籤，**Then** 自動切換至新頁籤繼續操作
3. **Given** 問卷頁面已載入，**When** 系統填寫問卷，**Then** 所有問題統一選擇第一個選項
4. **Given** 問卷已填寫完成，**When** 系統送出問卷，**Then** 關閉問卷頁籤並返回原頁面

---

### 邊緣案例

- **課程影片在深層 iframe 中**：系統需遞迴搜尋所有 frame 找到影片元素，透過視覺特徵（如視頻播放器外觀）鎖定正確的 iframe 上下文
- **課程來源分散、播放器樣式不一**：視為高機率跨域或 iframe，需先以 ARIA 快照建立對照表
- **考試有防作弊機制限制切換視窗**：若無法自動答題，降級為「輔助模式」顯示建議答案
- **問卷包含開放式填答題**：預設填入「無意見」或留空
- **網站進行維護中**：偵測維護頁面並暫停執行，通知用戶
- **影片播放中出現彈窗**：自動關閉彈窗並繼續播放
- **課程有前置課程要求**：跳過無法開始的課程並記錄原因
- **長時間執行導致 Session 過期**：執行過程中定期維持 Session 活躍
- **Moodle Session Timeout 警告彈窗**：自動偵測「您還在嗎？」彈窗並點擊延長會話
- **SCORM 課程跨域 iframe 限制**：透過事件注入繞過上層 UI 攔截
- **行為分析檢測觸發**：若偵測到異常警告，暫停操作並記錄

---

## 需求 *(必要)*

### 功能需求

#### 核心功能

- **FR-001**: 系統 MUST 支援載入已儲存的瀏覽器登入狀態（Cookies、LocalStorage）
- **FR-002**: 系統 MUST 能導航至 elearn 課程清單頁面並解析未完成課程
- **FR-003**: 系統 MUST 能自動進入課程並播放影片直到時數達標
- **FR-004**: 系統 MUST 能監控課程學習進度並在達標時自動退出
- **FR-005**: 系統 MUST 能擷取考試題目、選項並識別題型（單選/複選/是非），且 MUST 同時取得每個選項的 `inputName`（HTML input name 屬性）與 `inputValue`（HTML input value 屬性）以實現精準點擊定位
- **FR-006**: 系統 MUST 能將題目送往 Copilot SDK 代理推論（gpt-5-mini）並在 120 秒內取得答案
- **FR-007**: 系統 MUST 能自動選擇答案並送出考卷（包含是非題）。點擊定位 MUST 使用 `inputName + inputValue` 組合定位策略（CSS: `input[name="..."][value="..."]`），避免使用位置索引
- **FR-008**: 系統 MUST 能判讀考試分數並在未通過時自動重考
- **FR-009**: 系統 MUST 能處理問卷開啟新頁籤的情況
- **FR-010**: 系統 MUST 能自動填寫問卷（統一選第一個選項）並送出
- **FR-011**: 系統 MUST 能儲存執行進度至本地檔案
- **FR-012**: 系統 MUST 能從上次中斷的進度繼續執行
- **FR-013**: 系統 MUST 能偵測登入狀態過期並自動重新執行帳密登入
- **FR-014**: 系統 MUST 支援 eCPA 帳號密碼自動登入（取代 FIDO 手動登入）
- **FR-014**: 系統 MUST 能處理 iframe 嵌套結構（支援遞迴遍歷與視覺引導定位）
- **FR-015**: 系統 MUST 在發生可恢復錯誤時自動重試
- **FR-016**: 系統 MUST 支援收集 ARIA 快照並映射至可解析的課程/考試/問卷頁面

#### 繁體中文語意解析

- **FR-017**: 系統 MUST 能正確解析台灣繁體中文（zh-TW）課程清單表格，包含課程名稱、時數、狀態等在地化欄位
- **FR-018**: 系統 MUST 能正確理解繁體中文考試題目語意，包含題幹、選項與專有名詞
- **FR-019**: 系統 MUST 能識別繁體中文介面元素（如「開始學習」、「繼續」、「已完成」等按鈕與狀態標籤）

#### 反偵測與擬人化操作

- **FR-020**: 系統 MUST 能規避線上考試系統的「防機器人」機制，透過以下擬人化操作策略執行（詳見 FR-021~FR-023）：隨機延遲、心跳機制、貝塞爾曲線滑鼠軌跡
- **FR-021**: 系統 MUST 能通過「人類行為偵測」，在操作間引入符合正態分佈的隨機延遲（500ms - 1500ms）
- **FR-022**: 系統 MUST 能避免觸發「閒置偵測」，透過隱式心跳機制維持活躍狀態
- **FR-023**: 系統 MUST 能模擬非線性滑鼠移動軌跡（貝塞爾曲線），避免機械式直線移動

#### Moodle 平台專用優化

- **FR-024**: 系統 MUST 能處理 Moodle Session Timeout（20-30 分鐘），透過背景心跳請求維持會話活躍
- **FR-025**: 系統 MUST 能偵測並自動關閉「Session Timeout Warning」彈窗
- **FR-026**: 系統 MUST 能使用持久化瀏覽器上下文（Persistent Context），即使瀏覽器崩潰也能恢復登入狀態
- **FR-027**: 系統 MUST 能處理 SCORM 課程的跨域 iframe，透過視覺引導與事件注入進行操作

#### 錯誤處理與降級

- **FR-028**: 系統 MUST 在 LLM 連線失敗時立即提示用戶「LLM 連線失敗」，終止自動化流程並引導用戶人工查修
- **FR-029**: 系統 MUST 在 LLM 推論超過 120 秒未回應時視為逾時，觸發連線失敗處理流程

### 關鍵實體

- **Course（課程）**：代表一門學習課程，包含名稱、狀態（未完成/進行中/已完成）、所需時數、已學習時數、考試通過狀態、問卷完成狀態
- **ExamQuestion（考試題目）**：代表一道考試題目，包含題目類型、題目內容、選項列表（含 `inputName` + `inputValue` 精準定位屬性）
- **Progress（進度記錄）**：代表用戶的整體學習進度，包含最後更新時間、各課程的詳細進度
- **AuthState（登入狀態）**：代表用戶的瀏覽器登入狀態，包含 Cookies、Session Token

---

## 成功標準 *(必要)*

### 可衡量成果

- **SC-001**: 用戶執行單一指令即可完成一門課程的完整流程（上課+考試+問卷），無需人工介入
- **SC-002**: 課程學習時數達標判定準確率達 100%（含 5% 緩衝確保達標）
- **SC-003**: 考試自動答題通過率達 85% 以上（基於 Copilot SDK gpt-5-mini 推論）
- **SC-004**: 分天作業進度恢復準確率達 100%
- **SC-005**: 系統連續執行 20 次無失敗（穩定性測試）
- **SC-006**: 單門課程完整流程執行時間比手動操作減少 90% 以上
- **SC-007**: 支援同時管理 50 門以上課程的進度追蹤
- **SC-008**: 繁體中文課程清單與考試題目解析準確率達 95% 以上
- **SC-009**: 長時間執行（60 分鐘以上）無觸發閒置偵測或被判定為機器人
- **SC-010**: Moodle Session Timeout 警告自動處理成功率達 100%

---

## 第一性原理分析 *(參考)*

本節使用第一性原理與思維鏈（CoT）分析，深度理解系統設計的核心邏輯。

### 問題本質分解

```
用戶的真實需求：
├── 節省時間：不想手動操作重複性的學習流程
├── 確保合規：必須達到最低學習時數要求
├── 智能應答：需要 AI 輔助回答測驗問題
└── 持續性：分天作業需要記住進度

從第一性原理推導：
├── 「節省時間」→ 需要自動化操作 → 需要可靠的元素定位
├── 「確保合規」→ 需要時數監控 → 需要繞過閒置偵測
├── 「智能應答」→ 需要語意理解 → 需要雲端 AI（Copilot SDK gpt-5-mini）
└── 「持續性」→ 需要狀態持久化 → 需要處理 Session 過期
```

### 技術約束的推導

```
約束一：為何需要擬人化操作？
├── 前提：elearn 系統可能有行為分析
├── 若操作過快或過規律 → 可能被判定為機器人
├── 結論：MUST 引入隨機延遲與非線性滑鼠軌跡

約束二：為何 AI 推論需要 120 秒？
├── 前提：透過 Copilot SDK 呼叫雲端 gpt-5-mini 模型
├── 複雜題目需要深度推理 → 需要合理的計算時間
├── 雲端模型延遲取決於網路與負載
├── 結論：120 秒為合理的超時容忍度，逾時即視為連線失敗

約束三：為何需要視覺錨定？
├── 前提：網頁 DOM 結構可能變化
├── CSS 選擇器脆弱 → 網站改版即失效
├── 視覺特徵相對穩定 → 使用 ARIA 快照 + 視覺識別
├── 結論：MUST 使用語意選擇器而非位置導向
```

### 思維鏈：自動上課流程推演

```
步驟 1：用戶手動登入 elearn
    └── 系統保存 storageState（Cookies + LocalStorage）

步驟 2：執行 npm run course
    └── 載入已儲存的登入狀態
    └── 檢查登入是否有效（若無效則提示用戶）

步驟 3：導航至課程清單
    └── 等待頁面載入完成（使用智慧等待而非固定時間）
    └── 取得 ARIA 快照理解頁面結構

步驟 4：解析繁中課程表格
    └── 識別「未完成」狀態的課程
    └── 依序處理每門課程

步驟 5：進入課程並開始播放
    └── 點擊課程連結（使用語意選擇器）
    └── 處理可能的 iframe 嵌套（遞迴搜尋）
    └── 點擊播放按鈕

步驟 6：監控播放進度（每分鐘檢查）
    └── 比對觀看時數與 requiredMinutes
    └── 達標後自動退出
```
