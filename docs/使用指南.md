# 🏗️ 內部網路網頁素材蒐集工具 — 使用指南

> **版本**：1.2.0  
> **最後更新**：2026-02-10（已由 claude-opus-4.6 更新：錄製清理/ARIA 自動快照/Pre-commit Hook）  
> **目標環境**：Windows 11 + PowerShell 7.x  
> **目標讀者**：一般使用者（不需要程式設計經驗）

---

## 📋 目錄

1. [這個工具在做什麼？](#1-這個工具在做什麼)
2. [資料夾內容說明](#2-資料夾內容說明)
3. [第一次使用：環境安裝](#3-第一次使用環境安裝)
4. [啟動 Chrome Debug 模式](#4-啟動-chrome-debug-模式)
5. [執行素材蒐集](#5-執行素材蒐集)
6. [檢查蒐集結果](#6-檢查蒐集結果)
7. [帶出素材到外網](#7-帶出素材到外網)
8. [用 AI 生成自動化腳本（含提示詞）](#8-用-ai-生成自動化腳本含提示詞)
9. [將腳本帶回內網測試](#9-將腳本帶回內網測試)
10. [後續維護與故障排除](#10-後續維護與故障排除)
11. [安全準則與憑證管理](#11-安全準則與憑證管理)
12. [CDP 連線原則與優雅關閉](#12-cdp-連線原則與優雅關閉)
13. [指令速查表](#13-指令速查表)

---

## 1. 這個工具在做什麼？

### 用白話說

你要做的事情很簡單，就像「拍照 → 找設計師 → 裝潢」：

```
步驟一：在內部網路的電腦上「拍照」（蒐集網頁的結構資料）
    ↓
步驟二：把「照片」帶到有網路的地方
    ↓
步驟三：給 AI「設計師」看照片，請它幫你寫自動化腳本
    ↓
步驟四：把 AI 寫好的腳本帶回內部網路測試
```

### 為什麼需要這樣做？

因為內部網路沒有網際網路，無法直接使用雲端 AI。所以我們分成兩步：
1. **在內網**：用工具蒐集網頁的「骨架資料」（不含任何敏感內容）
2. **在外網**：把骨架資料給 AI 分析，讓 AI 幫你寫出自動化腳本

### 蒐集的是什麼？

| 素材類型 | 用白話說 | 安全性 |
|---------|---------|--------|
| 📄 **ARIA 快照** | 網頁的「骨架圖」— 列出頁面上有什麼按鈕、表格、輸入框 | ✅ 安全（不含密碼或個資） |
| 📸 **截圖** | 網頁的「照片」— 讓你確認蒐集到的是正確頁面 | ⚠️ 需人工檢查有無個資 |
| 🎬 **錄製檔** | 操作的「動作記錄」— 記錄你按了哪些按鈕、點了哪裡 | ✅ 安全（只有動作序列） |

> 💡 **重點**：ARIA 快照是最重要的素材。AI 主要靠它來理解網頁結構。

---

## 2. 資料夾內容說明

你拿到的 `automation` 資料夾包含以下檔案：

| 檔案 | 用途 | 你需要動它嗎？ |
|------|------|--------------|
| `使用指南.md` | 就是本文件 | ❌ 只需閱讀 |
| `setup.ps1` | 一鍵安裝腳本 | ✅ 第一次使用時執行一次 |
| `launch-chrome.ps1` | 啟動 Chrome Debug 模式 | ✅ 每次蒐集前執行 |
| `logs\` | 執行日誌（安裝 / 啟動 / 蒐集） | ✅ 出問題時提供給 AI |
| `collect-materials.ts` | 素材蒐集工具主程式 | ❌ 不需要修改 |
| `collect-materials-config.json` | 自動模式設定檔 | ⚙️ 使用自動模式時才需要修改 |
| `package.json` | Node.js 專案設定 | ❌ 不需要修改 |
| `tsconfig.json` | TypeScript 設定 | ❌ 不需要修改 |

---

## 3. 第一次使用：環境安裝

### 3.1 前置條件

你的電腦需要安裝：
- **Windows 11** + **PowerShell 7.x**（按 `Win + X` 開啟「終端機」即可）
- **Node.js v20 以上版本**
- **Google Chrome**（用來開啟 Debug 模式）

**怎麼確認有沒有安裝？**

1. 按 `Win + X`，選「終端機」或「PowerShell」
2. 輸入：`node --version`
3. 如果看到 `v20.x.x` 或更高版本，就 OK
4. 如果看到錯誤訊息，請到 https://nodejs.org/ 下載安裝

> 📌 **CDP_PORT 預設為 9222**（可透過 `.\launch-chrome.ps1 -Port 9223` 或 `--port 9223` 自訂，設定檔對應欄位為 `cdpPort`）。

### 3.2 安裝工具依賴

**情境 A：電腦可以上網**

在 PowerShell 中執行：

```powershell
# 進入 automation 資料夾
cd C:\path\to\automation

# 執行一鍵安裝
.\setup.ps1
```

> ⚠️ 如果出現「無法執行腳本」的錯誤，請先執行：
> ```powershell
> Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
> ```
> 這是 Windows 的安全設定，只需要設一次。

**預期結果**：看到三個 ✅ 表示安裝成功：
```
  ✅ Node.js v22.x.x
  ✅ 程式庫安裝完成
  ✅ Playwright Chromium 安裝完成
  🎉 安裝完成！
```

> 🧾 安裝過程會產生日誌：`logs\setup-YYYYMMDD-HHMMSS.log`  
> 如果安裝失敗，把最新的 log 提供給 AI 即可快速定位問題。

**情境 B：電腦完全沒有網路（離線安裝）**

1. 先在有網路的電腦上執行 `setup.ps1`
2. 安裝完成後，把整個 `automation` 資料夾（**含 `node_modules` 資料夾**）複製到隨身碟
3. 把隨身碟帶到內網電腦，把 `automation` 資料夾複製到內網電腦上

> 📌 **重要**：`node_modules` 資料夾很大（約 200-300MB），但它包含了所有需要的程式庫。離線環境必須帶著它。

---

## 4. 啟動 Chrome Debug 模式

### 為什麼需要這步？

蒐集工具需要「連接」到你的 Chrome 瀏覽器，才能讀取網頁的結構資料。
這就像讓工具「看著你的螢幕」來記錄頁面資訊。

### 4.1 啟動步驟

**步驟一**：關閉所有正在運行的 Chrome 視窗

**步驟二**：在 PowerShell 中執行：

```powershell
cd C:\path\to\automation
.\launch-chrome.ps1
```

**預期結果**：
```
  ✅ Chrome Debug 模式已成功啟動！
  瀏覽器版本: Chrome/xxx.x.xxxx.xx
```

> 🧾 啟動過程日誌：`logs\launch-chrome-YYYYMMDD-HHMMSS.log`

### 4.2 驗證成功

在剛開啟的 Chrome 瀏覽器網址列輸入：

```
http://localhost:9222/json/version
```

**預期結果**：看到一段 JSON 格式的文字，代表啟動成功。

### 4.3 登入你的內部網站

在剛開啟的 Debug Chrome 中：
1. 前往你要自動化的內部網站
2. 手動登入你的帳號
3. 確認可以看到你要蒐集的頁面

> 📌 **重要**：蒐集工具會「看到」你在 Chrome 中看到的內容。所以你要先登入，讓工具可以看到登入後的頁面。

---

## 5. 執行素材蒐集

### 5.1 互動模式（推薦新手使用）

**開啟另一個 PowerShell 視窗**（Chrome 那個視窗不要關），執行：

```powershell
cd C:\path\to\automation
npm run collect
```

**操作流程**：

1. 工具會顯示模式選單 → 輸入 `1` 選互動模式
2. 輸入專案名稱（例如：`公文簽核系統`）
3. 輸入輸出目錄 → 直接按 Enter 使用預設
4. 工具會顯示當前 Chrome 頁面的資訊
5. 輸入頁面名稱（例如：`01-login-page`）
6. 輸入頁面描述（例如：`系統登入頁面`）
7. 工具自動擷取 ARIA 快照 + 截圖
8. 問你要不要繼續蒐集下一個頁面
9. 在 Chrome 中導航到下一個頁面，按 Enter 繼續

**實際操作畫面範例**：

```
  +==============================================================+
  |  🏗️  內部網路網頁素材離線蒐集工具 v1.0.0                      |
  |  完全離線運作 • 不需要網際網路 • 基於 Playwright            |
  +==============================================================+

  請選擇蒐集模式：

  [1] 📸 互動模式（推薦新手）- 一步一步引導你蒐集
  [2] 🤖 自動模式 - 依設定檔自動蒐集所有頁面
  [3] ⚡ 快照模式 - 快速擷取當前頁面
  [4] 🎬 錄製模式 - 啟動 Codegen 錄製互動流程

  請選擇 (1/2/3/4): 1
  專案名稱: 公文簽核系統
  輸出目錄 (Enter=./materials):

  -- 蒐集頁面: 系統登入頁面 (01-login-page) --

  📸 擷取 ARIA 快照: 系統登入頁面
  ✅ 已儲存: 01-login-page.txt (2048 bytes)
  📷 擷取截圖: 系統登入頁面
  ✅ 已儲存: 01-login-page.png (154320 bytes)

  接下來要做什麼？
    [Enter] 繼續蒐集下一個頁面
    [r]     錄製互動流程 (codegen)
    [q]     結束蒐集
  你的選擇:
```

### 5.2 快照模式（快速擷取當前頁面）

如果你只想快速擷取 Chrome 中目前顯示的頁面：

```powershell
npm run collect:snapshot
```

**使用場景**：你在操作過程中發現一個重要頁面，想趕快擷取下來。

### 5.3 自動模式（依設定檔批次蒐集）

如果你已經知道要蒐集哪些頁面，可以先編輯設定檔，然後自動蒐集。

**第一步**：用記事本開啟 `collect-materials-config.json`，修改頁面清單：

```json
{
  "projectName": "公文簽核系統",
  "description": "蒐集公文簽核系統的自動化素材",
  "cdpPort": 9222,
  "outputDir": "./materials",
  "collectOptions": {
    "ariaSnapshot": true,
    "screenshot": true,
    "codegenRecording": true,
    "htmlSource": false,
    "iframeDepth": 3
  },
  "pages": [
    {
      "name": "01-login",
      "url": "http://your-internal-site/login",
      "description": "登入頁面",
      "waitFor": "networkidle",
      "actions": []
    },
    {
      "name": "02-dashboard",
      "url": "http://your-internal-site/dashboard",
      "description": "首頁儀表板",
      "waitFor": "networkidle",
      "actions": []
    }
  ],
  "interactiveFlows": []
}
```

> 💡 **提示**：把 `url` 欄位改成你實際的內部網站網址。

**第二步**：執行自動蒐集

```powershell
npm run collect:auto
```

### 5.4 錄製模式（Codegen 互動錄製）

<!-- Implemented T-01, T-02, T-03, T-04 by claude-opus-4.6 on 2026-02-10 -->

如果你要錄製一段操作流程（例如：登入流程、填寫表單流程）：

```powershell
# 基本用法
npm run collect:record

# 指定錄製名稱和起始網址
npx tsx collect-materials.ts --record login-flow --url http://your-internal-site/login
```

**操作方式**：
1. 工具會開啟一個新的瀏覽器視窗
2. 你在這個視窗中操作要錄製的流程
3. 完成後，關閉瀏覽器視窗即結束錄製
4. 錄製結果會自動存到 `materials\recordings\` 資料夾
5. **（自動）** 工具會自動清理錄製檔中的明文密碼，替換為 `process.env.RECORDING_PASSWORD`
6. **（自動）** 工具會解析錄製檔中的 `page.goto()` URL，逐一開啟並擷取 ARIA 快照

**錄製完成後的自動流程**：

```
✅ 錄製完成！
📄 錄製檔案已儲存到: materials/recordings/login-flow.ts
🔐 敏感資訊清理完成（密碼欄位已替換為環境變數）
🔜 正在擷取錄製過程中訪問的頁面快照...
📸 擷取 ARIA 快照: login-flow-url1 (http://your-internal-site/login)
📸 擷取 ARIA 快照: login-flow-url2 (http://your-internal-site/dashboard)
✅ 所有頁面快照擷取完成
```

> 💡 **RECORDING_PASSWORD 設定**：若需要在錄製檔中保留可用的密碼佔位值，請在執行前設定環境變數：
> ```powershell
> $env:RECORDING_PASSWORD = "your-password"
> ```
> 或在專案目錄下建立 `.env` 檔案（已被 `.gitignore` 排除）：
> ```
> RECORDING_PASSWORD=your-password
> ```

### 5.5 注意事項

- **互動模式**最多可連續蒐集 100 個頁面（安全上限）
- **iframe 深度**預設為 3 層。越深蒐集時間越長
- 如果 ARIA 快照擷取失敗，工具會自動用 HTML 結構解析作為替代方案

---

## 6. 檢查蒐集結果

### 6.1 確認素材目錄

蒐集完成後，你會在 `materials\` 資料夾看到以下結構：

```
materials\
├── aria-snapshots\           ← 最重要！AI 分析的核心素材
│   ├── 01-login-page.txt
│   ├── 02-dashboard.txt
│   └── ...
├── screenshots\              ← 視覺參考
│   ├── 01-login-page.png
│   ├── 02-dashboard.png
│   └── ...
├── recordings\               ← 操作流程記錄（使用錄製模式時產生）
│   └── login-flow.ts
├── metadata.json             ← 蒐集記錄（時間、頁面 URL 等）
└── summary-report.md         ← 蒐集摘要報告
```

> 🧾 蒐集日誌會存放在 `logs\collect-materials-YYYYMMDD-HHMMSS.log`

> ⏰ **時區**：所有時間戳記（日誌、metadata.json、ARIA 快照 header）統一使用台北時間 `Asia/Taipei (UTC+8)`。`metadata.json` 的 `timezone` 欄位值為 `Asia/Taipei (UTC+8)`。

### 6.2 驗證 ARIA 快照品質

用記事本打開 `aria-snapshots\` 目錄中的 `.txt` 檔案，你會看到類似這樣的內容：

```
# ARIA 快照: 系統登入頁面
# 擷取時間: 2026-02-08T10:30:00+08:00
# 頁面 URL: http://internal-site/login
# 頁面標題: 系統登入

- heading "系統登入" [level=1]
- form:
  - textbox "帳號"
  - textbox "密碼" [type=password]
  - button "登入"
- link "忘記密碼"
```

**品質檢查要點**：
- ✅ 能看到頁面上的按鈕名稱、輸入框名稱、連結文字
- ✅ 有標題（heading）、表格（table）、表單（form）等結構
- ❌ 如果內容幾乎是空的，需要重新蒐集

### 6.3 安全檢查

**在帶出素材之前，請檢查**：

| 檢查項目 | 怎麼檢查 | 處理方式 |
|---------|---------|---------|
| ARIA 快照中有無個人資料 | 用記事本搜尋身分證號、姓名 | 通常沒有（ARIA 只記錄結構） |
| 截圖中有無個人資料 | 用眼睛看截圖 | 有的話刪除該截圖 |
| 錄製檔中有無密碼 | 用記事本搜尋 password、密碼 | 刪除含密碼的行 |

> 📌 **最安全的做法**：只帶出 `aria-snapshots\` 和 `recordings\` 目錄。截圖可以不帶。

---

## 7. 帶出素材到外網

### 7.1 準備攜出

1. 確認安全檢查已完成（第 6.3 節）
2. 將 `materials\` 資料夾複製到隨身碟或經核准的傳輸管道
3. 依據機關資安政策完成攜出審批程序

### 7.2 最小攜出方案（最安全）

如果你只想攜出最安全的素材：

```powershell
# 只複製 ARIA 快照和錄製檔（核心素材）
Copy-Item -Recurse materials\aria-snapshots\ D:\USB\
Copy-Item -Recurse materials\recordings\ D:\USB\

# 選擇性攜出 metadata.json（包含頁面 URL 和標題，幫助 AI 理解脈絡）
Copy-Item materials\metadata.json D:\USB\
```

> 💡 **metadata.json 說明**：此檔案記錄了每個頁面的 URL 和標題。如果你的內部網址本身就是機敏資訊，可以不攜出此檔案。

---

## 8. 用 AI 生成自動化腳本（含提示詞）

### 8.1 🌟 生成自動化腳本的提示詞

在有網路的環境中，打開你偏好的 AI 工具（ChatGPT、Claude、Copilot 等），**複製以下提示詞**，然後把你的 ARIA 快照和錄製檔貼在後面。

---

<details>
<summary>📋 點擊展開：AI 生成自動化腳本提示詞（完整版，直接複製使用）</summary>

````
你是一位世界級的 Playwright 自動化腳本專家。

## 任務

根據我提供的「ARIA 快照」和「Codegen 錄製檔」，為內部網路系統生成一個完整的 Playwright TypeScript 自動化腳本。

## 核心設計原則（Non-Negotiable）

### 1. 內容驅動選擇器（最重要）
- ✅ 必須使用語意選擇器：`page.getByRole('button', { name: '登入' })`, `page.getByLabel('帳號')`
- ✅ 必須使用文字定位：`page.getByText('確認送出')`
- ✅ 備用方案：當語意選擇器不適用時，可用穩定的 data 屬性：`page.locator('[data-testid="submit"]')`
- ❌ 禁止使用位置導向選擇器：`cells[3]`, `div:nth-child(2)`
- ❌ 禁止使用脆弱的 CSS 類名：`.btn-primary`, `#form_123`
- ❌ 禁止使用自動產生的 ID（如 `#ctl00_ContentPlaceHolder1_btn`）

### 選擇器優先級策略
1. 第一優先：`getByRole()` + `name`（從 ARIA 快照取得）
2. 第二優先：`getByLabel()` / `getByText()` / `getByPlaceholder()`
3. 第三優先：`locator('[data-*="..."]')` 穩定的 data 屬性
4. 最後手段：`locator('#id')` 但只用看起來穩定的 ID（非自動產生的）

### 2. 智慧等待（不用固定等待）
- ✅ 使用 `page.waitForSelector()`, `page.waitForLoadState('networkidle')`
- ✅ 使用 `page.getByRole('button').waitFor({ state: 'visible' })`
- ❌ 禁止使用 `page.waitForTimeout(5000)` 這類固定等待

### 3. iframe 處理
- 如果 ARIA 快照顯示有 iframe，必須正確進入 iframe 操作
- 使用 `page.frameLocator('#frameName')` 或 `page.locator('iframe').contentFrame()`

### 4. 錯誤處理
- 每個關鍵操作都要 try-catch
- 遇到可恢復的錯誤，自動重試（最多 3 次）
- 遇到不可恢復的錯誤，記錄日誌並安全退出

### 5. dialog 處理
- 如果流程涉及 `window.confirm()` 或 `window.alert()`
- 必須在觸發 dialog 的操作「之前」用 `page.evaluate` 覆寫：
  ```typescript
  await page.evaluate(() => {
    window.confirm = () => true;
    window.alert = () => {};
  });
  ```
- 這是最可靠的方式，不要使用 `page.on('dialog')` 事件處理

### 6. popup / 新分頁處理
- 如果操作會開啟新視窗（如：測驗頁面、填寫表單），使用：
  ```typescript
  const popupPromise = page.context().waitForEvent('page');
  await page.getByText('進行測驗').click();
  const popupPage = await popupPromise;
  await popupPage.waitForLoadState('domcontentloaded');
  ```

## 輸出格式

請生成一個完整的 TypeScript 檔案，包含以下結構：

```typescript
/**
 * [系統名稱] 自動化腳本
 *
 * 功能：[描述自動化的流程]
 * 生成日期：[日期]
 * 基於素材：[列出使用的 ARIA 快照]
 */

import { chromium, Page, Browser } from 'playwright';

// ============================================================
// 設定
// ============================================================

const CONFIG = {
  CDP_PORT: 9222,
  BASE_URL: '[從 ARIA 快照中的 URL 推斷]',
  TIMEOUT: 30000,
  RETRY_COUNT: 3,
};

// ============================================================
// 工具函數
// ============================================================

async function connectToChrome(): Promise<{ browser: Browser; page: Page }> {
  const browser = await chromium.connectOverCDP(`http://localhost:${CONFIG.CDP_PORT}`);
  const context = browser.contexts()[0];
  const page = context.pages()[0];
  return { browser, page };
}

async function retry<T>(fn: () => Promise<T>, retries = CONFIG.RETRY_COUNT): Promise<T> {
  for (let i = 0; i < retries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === retries - 1) throw error;
      console.log(`重試 ${i + 1}/${retries}...`);
      await new Promise(r => setTimeout(r, 2000));
    }
  }
  throw new Error('不應該執行到這裡');
}

// ============================================================
// 主要自動化邏輯
// ============================================================

async function main(): Promise<void> {
  console.log('🚀 開始執行自動化...');
  const { browser, page } = await connectToChrome();

  try {
    // [根據 ARIA 快照和錄製檔生成具體步驟]
    // 步驟 1: ...
    // 步驟 2: ...
  } catch (error) {
    console.error('❌ 執行失敗:', (error as Error).message);
  }
  // 注意：使用 CDP 連接時，不要呼叫 browser.close()
}

main().catch(console.error);
```

## 重要注意事項

1. 使用 CDP 連接（`connectOverCDP`），不是啟動新瀏覽器（`chromium.launch`）
2. 連接後不要呼叫 `browser.close()`，因為那會關掉使用者的 Chrome
3. 所有選擇器優先使用 ARIA 快照中的語意資訊（role, name, text）
4. 如果錄製檔中有位置導向的選擇器（如 `nth(3)`），請改用語意選擇器
5. 在 Windows 環境下，codegen 錄製使用 `npx.cmd` 而非 `npx`

## 以下是我的素材

### ARIA 快照

[在這裡貼上你的 ARIA 快照內容]

### Codegen 錄製檔

[在這裡貼上你的錄製檔內容]
````

</details>

---

### 8.2 如何使用提示詞

**步驟一**：複製上面的完整提示詞

**步驟二**：打開 AI 工具（ChatGPT / Claude / Copilot）

**步驟三**：將提示詞貼入對話框

**步驟四**：在提示詞的最後，貼上你的素材

格式如下：
```
[提示詞]

### ARIA 快照

[打開 materials\aria-snapshots\ 裡的 .txt 檔案，複製全部內容貼上]
[如果有多個頁面，每個頁面的快照都貼上，用分隔線隔開]

### Codegen 錄製檔

[打開 materials\recordings\ 裡的 .ts 檔案，複製全部內容貼上]
```

**步驟五**：送出，等待 AI 回覆

**步驟六**：AI 會給你一個完整的 TypeScript 檔案。將它儲存為 `.ts` 檔案（例如 `my-automation.ts`）

### 8.3 多個頁面的素材如何整理

| 場景 | 建議做法 |
|------|---------|
| 頁面少（1-5 個） | 全部貼在同一次對話中 |
| 頁面多（6-20 個） | 依流程分組，每次 3-5 個頁面 |
| 頁面非常多（20+） | 先給 AI 總覽（metadata.json），再逐組提供 |

### 8.4 品質提升技巧

- **加入錄製檔**：如果有 Codegen 錄製檔，AI 生成的腳本品質會大幅提升
- **描述你的流程**：在提示詞後面用文字描述你想自動化的完整流程
- **提供多個頁面**：同一流程的所有頁面都提供，AI 能生成完整的端到端腳本

---

## 9. 將腳本帶回內網測試

### 9.1 準備測試

1. 將 AI 生成的 `.ts` 檔案帶回內網電腦
2. 放到 `automation` 資料夾下

### 9.2 執行測試

```powershell
cd C:\path\to\automation

# 確認 Chrome Debug 模式正在運行（見第 4 節）
# 然後執行你的自動化腳本
npx tsx my-automation.ts
```

### 9.3 如果腳本不能正常運作

別擔心，這很正常。通常需要微調 1-2 次。

**處理方式**：
1. 記錄下錯誤訊息
2. 重新蒐集出問題的頁面的 ARIA 快照（使用快照模式 `npm run collect:snapshot`）
3. 把錯誤訊息 + 新快照一起給 AI 修正（使用下面的除錯提示詞）

---

### 9.4 日誌（LOG）收集與提供

每次執行都會在 `logs\` 產生日誌檔，內含環境資訊、參數、錯誤與堆疊：

- `setup-YYYYMMDD-HHMMSS.log`
- `launch-chrome-YYYYMMDD-HHMMSS.log`
- `collect-materials-YYYYMMDD-HHMMSS.log`

遇到問題時請提供：
1. 最新的 log 檔（上述）
2. `materials\metadata.json`（若有）
3. 問題發生時的操作步驟

> 只要把 log 丟給 AI，就能精準定位問題根因。

## 10. 後續維護與故障排除

### 10.1 常見問題與解決方案

#### 問題一：「找不到按鈕」/ 「元素不存在」

**原因**：網頁改版了，按鈕名稱或位置有變化。

**解決方式**：
1. 在 Chrome 中打開出問題的頁面
2. 執行 `npm run collect:snapshot` 重新蒐集快照
3. 用除錯提示詞（下面的 10.2 節）讓 AI 修正

#### 問題二：「超時」/ 「等待逾時」

**原因**：頁面載入太慢，或等待的元素沒有出現。

**解決方式**：增加超時時間（在腳本中將 `timeout: 30000` 改為 `timeout: 60000`），或用除錯提示詞請 AI 修正。

#### 問題三：「連接失敗」/ 「CDP 連接錯誤」

**原因**：Chrome Debug 模式沒有啟動。

**解決方式**：
1. 關閉所有 Chrome 視窗
2. 重新執行 `.\launch-chrome.ps1`
3. 確認 `http://localhost:9222/json/version` 可以訪問

#### 問題四：「iframe 中的元素找不到」

**原因**：需要先進入 iframe 才能操作裡面的元素。

**解決方式**：重新蒐集快照（工具會自動記錄 iframe 結構），把新快照給 AI 修正。

#### 問題五：「dialog 彈出導致腳本崩潰」

**原因**：網頁彈出了 confirm/alert 對話框，腳本沒有處理。

**解決方式**：在觸發 dialog 的操作之前加入：

```typescript
await page.evaluate(() => {
  window.confirm = () => true;
  window.alert = () => {};
});
```

#### 問題六：PowerShell 無法執行 .ps1 腳本

**原因**：Windows 安全性原則阻擋了腳本執行。

**解決方式**：
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

#### 問題七：「Codegen 錄製失敗 / spawn EINVAL」

**原因**：Node.js 在 Windows 上直接呼叫 `npx.cmd` 可能失敗。

**解決方式**：
1. 確認已更新到最新版本的專案（含新的 `collect-materials.ts`）
2. 重新執行 `.\setup.ps1`
3. 檢查 `logs\collect-materials-*.log` 中的 `codegenCommand`，並手動測試：

```powershell
npx playwright codegen --help
```

#### 問題八：「找不到正確頁面」/ 選到 Chrome 內部頁面

**原因**：Chrome CDP 會列出內部頁面（如 `chrome://omnibox-popup`、`chrome://newtab-footer`），如果沒有過濾就會選到錯誤的頁面。

**症狀**：日誌中出現 `getActivePage: 選擇使用者頁面` 顯示 `chrome://` 開頭的 URL，或出現「所有頁面都是 Chrome 內部頁面」警告。

**解決方式**：
1. 確認 Chrome 中已打開你的目標網站（不只是新分頁）
2. 工具已自動過濾 `chrome://`、`chrome-extension://`、`chrome-untrusted://`、`devtools://`、`about:blank` 等內部頁面
3. 如果所有頁面都被過濾，請在 Chrome 中先瀏覽到你要蒐集的網站

#### 問題十：「頁面需要重新附加」/ CDP 預存頁面無法操作

**原因**：透過 `connectOverCDP` 連接到 Chrome 時，在連接前就已經開啟的頁面（稱為「預存頁面」）會出現 `page.url()` 為空字串的情況，導致截圖和 ARIA 快照無法直接擷取。

**症狀**：日誌中出現 `頁面需要重新附加（CDP 預存頁面）` 或 `偵測到 CDP 預存頁面`。

**解決方式**：
1. 工具已**自動處理**此問題：偵測到預存頁面時，會透過 CDPSession 取得真實 URL，然後開啟新分頁並導航到同一 URL
2. 你會看到 Chrome 多開一個分頁（這是正常行為），蒐集完成後可手動關閉
3. 如果自動處理失敗，請先在 Chrome 中手動重新整理（F5）目標頁面，然後再執行蒐集

#### 問題九：「端口 9222 已被佔用」/ 一般 Chrome 佔用了 debug 端口

**原因**：普通的 Chrome 瀏覽器或其他程式已佔用了端口 9222。

**解決方式**：
1. 關閉所有 Chrome 視窗
2. 重新執行 `.\launch-chrome.ps1`
3. 腳本會自動偵測端口佔用者，並提示你是否要強制關閉

### 10.2 🔧 AI 除錯提示詞

當你的自動化腳本出了問題，用以下提示詞請 AI 幫你修正：

---

<details>
<summary>📋 點擊展開：AI 除錯提示詞（完整版，直接複製使用）</summary>

````
你是一位世界級的 Playwright 自動化除錯專家。

## 背景

我有一個 Playwright TypeScript 自動化腳本在內部網路系統上執行時出了問題。
請根據我提供的「錯誤訊息」、「目前的腳本程式碼」、「最新的 ARIA 快照」來修正問題。

## 除錯原則

### 1. 根本原因分析
- 先分析錯誤訊息，判斷是哪種類型的問題
- 常見問題類型：
  - 選擇器失效（元素名稱/結構變了）
  - 超時（頁面載入太慢、元素沒有出現）
  - iframe 未進入（操作在錯誤的 frame 中）
  - dialog 未處理（confirm/alert 彈出）
  - 導航失敗（URL 變更、重新導向）

### 2. 優先使用 ARIA 快照中的語意資訊修正選擇器
- 對比「舊快照」和「新快照」的差異
- 用新快照中的 role、name、text 更新選擇器
- ✅ `page.getByRole('button', { name: '新的按鈕名稱' })`
- ❌ 不要使用 CSS 選擇器或 XPath

### 3. 保留原有的正確邏輯
- 只修改出問題的部分
- 不要重寫整個腳本
- 保留所有正確的錯誤處理和重試邏輯

### 4. 加入防禦性程式碼
- 在修正的位置加入更好的錯誤處理
- 加入 `waitFor` 確保元素存在後再操作
- 加入 `try-catch` 包裹修正的區塊

## 輸出格式

1. **問題診斷**：說明你判斷的根本原因
2. **修正方案**：描述修正策略
3. **修正後的程式碼**：只顯示需要修改的程式碼段落（標明行號或前後文）
4. **預防建議**：如何避免同類問題再次發生

## 以下是我的資料

### 錯誤訊息

[在這裡貼上完整的錯誤訊息和 stack trace]

### 目前的腳本程式碼

[在這裡貼上你的 .ts 腳本程式碼]

### 最新的 ARIA 快照（重新蒐集的）

[在這裡貼上重新蒐集的 ARIA 快照]
````

</details>

---

### 10.3 定期維護建議

| 時機 | 建議動作 | 預計時間 |
|------|---------|---------|
| 每月一次 | 重新蒐集所有頁面的 ARIA 快照，確認腳本仍然正常 | 30 分鐘 |
| 系統升級後 | 立即重新蒐集快照 + 測試腳本 | 1-2 小時 |
| 腳本失敗時 | 蒐集出問題頁面的新快照 → 用除錯提示詞修正 | 30 分鐘 |
| 新增自動化流程 | 蒐集新頁面的快照 → 用生成提示詞產生新腳本 | 1-2 小時 |

### 10.4 素材版本管理

建議每次蒐集都保存為不同的版本：

```powershell
# 蒐集完成後，將 materials 重新命名為帶日期的版本
Rename-Item materials materials-2026-02-08

# 下次蒐集時會自動建立新的 materials 目錄
npm run collect
```

---

## 11. 安全準則與憑證管理

<!-- Implemented T-04, T-05 by claude-opus-4.6 on 2026-02-10 -->

### 11.1 禁止明文憑證

- ❌ **MUST NOT** 在原始碼（`.ts`）或錄製檔（`materials/recordings/*.ts`）中留下明文帳號密碼
- ❌ **MUST NOT** 將 `.env` 檔案提交到 Git（已在 `.gitignore` 中排除）

### 11.2 錄製檔自動清理（sanitizeRecording）

錄製結束後，工具會自動執行 `sanitizeRecording()`：

1. 掃描錄製檔中所有 `.fill()` 呼叫
2. 偵測密碼相關欄位（名稱含「密碼」、「password」的輸入框）
3. 將明文密碼值替換為 `process.env.RECORDING_PASSWORD`
4. 在檔案開頭加入清理標記：`// ⚠️ 此錄製檔已經過敏感資訊清理`

### 11.3 設定 RECORDING_PASSWORD 環境變數

```powershell
# 方法一：在 PowerShell 中設定環境變數（當次有效）
$env:RECORDING_PASSWORD = "your-password"
npx tsx collect-materials.ts --record login-flow

# 方法二：建立 .env 檔案（已被 .gitignore 排除）
# 在 automation 目錄下建立 .env 檔案，內容如下：
# RECORDING_PASSWORD=your-password
```

### 11.4 Pre-commit Hook 安全防護

<!-- Implemented T-05 by claude-opus-4.6 on 2026-02-10 -->

#### 啟用 .githooks

```powershell
# 一次性設定（在 automation 目錄下執行）
git config core.hooksPath .githooks
```

#### Hook 掃描邏輯

每次執行 `git commit` 時，`.githooks/pre-commit` 會呼叫 `scripts/pre-commit-scan.ps1`，掃描以下模式：

| 掃描模式 | 說明 |
|---------|------|
| `.fill(selector, 'password')` | 密碼欄位的明文值 |
| `password = 'xxx'` / `password: 'xxx'` | 密碼變數賦值 |
| `token = 'xxx'` / `token: 'xxx'` | Token 明文 |
| `secret = 'xxx'` / `secret: 'xxx'` | Secret 明文 |

若偵測到匹配，commit 會被阻止並提示修正。

#### 驗證 Hook 是否生效

```powershell
# 確認 hooksPath 設定
git config core.hooksPath
# 預期輸出: .githooks

# 測試掃描（不實際 commit）
pwsh -File scripts\pre-commit-scan.ps1
```

### 11.5 使用環境變數（自動化腳本）

如果自動化腳本需要帳號密碼，請使用環境變數：

```powershell
# 方法一：在 PowerShell 中設定環境變數（當次有效）
$env:NCERT_USERNAME = "your-username"
$env:NCERT_PASSWORD = "your-password"
npx tsx my-automation.ts

# 方法二：建立 .env 檔案（已被 .gitignore 排除）
# 在 automation 目錄下建立 .env 檔案，內容如下：
# NCERT_USERNAME=your-username
# NCERT_PASSWORD=your-password
```

在腳本中讀取：

```typescript
const username = process.env.NCERT_USERNAME;
const password = process.env.NCERT_PASSWORD;
if (!username || !password) {
  throw new Error('請設定 NCERT_USERNAME 和 NCERT_PASSWORD 環境變數');
}
```

### 11.6 .gitignore 安全項目

目前 `.gitignore` 已包含以下敏感項目：

| 項目 | 說明 |
|------|------|
| `.env` | 環境變數檔案（可能含帳密） |
| `logs/` | 日誌檔案（可能含環境資訊） |
| `materials/` | 蒐集的素材（可能含截圖中的個資） |
| `chrome-debug-profile/` | Chrome 設定檔（含登入 session） |

---

## 12. CDP 連線原則與優雅關閉

### 12.1 CDP 連線原則

本工具使用 `chromium.connectOverCDP()` 連接到使用者已開啟的 Chrome。關鍵原則：

| 原則 | 說明 |
|------|------|
| **NEVER `browser.close()`** | 呼叫 `browser.close()` 會關閉使用者的 Chrome，只能設 `this.browser = null` 斷開連線 |
| **過濾內部頁面** | `chrome://`、`chrome-extension://`、`chrome-untrusted://`、`devtools://`、`about:blank` 全部過濾 |
| **預存頁面處理** | `page.url() === ''` 的頁面使用 CDPSession 取得真實 URL，並自動開新分頁導航 |

### 12.2 `browser.close()` vs `browser.disconnect()` vs `this.browser = null`

```
browser.close()        → ❌ 關閉整個 Chrome 瀏覽器（禁止！）
browser.disconnect()   → ⚠️ 斷開 Playwright 與 Chrome 的連線（Playwright 內建方法）
this.browser = null    → ✅ 本工具使用的方式：釋放參考，讓 GC 清理
```

> 本工具的 `disconnect()` 方法只做 `this.browser = null`，因為 `connectOverCDP` 的語意是「連接到別人的瀏覽器」，我們無權關閉它。

### 12.3 SIGINT/SIGTERM 優雅關閉

當使用者按下 Ctrl+C 時：

```
Ctrl+C → SIGINT 信號
         ↓
    activeCollector.requestShutdown()
         ↓
    isShuttingDown = true
         ↓
    蒐集迴圈在下一輪迭代停止
         ↓
    進入 finally 區塊
         ↓
    ├── saveMetadata()         → metadata.json 寫入
    ├── generateSummaryReport() → summary-report.md 寫入
    └── disconnect()           → 斷開連線（Chrome 保持運行）
```

**重要**：即使中途按 Ctrl+C，`metadata.json` 和 `summary-report.md` 仍會被正確寫入。

### 12.4 日誌格式與位置

所有日誌存放於 `logs/` 目錄：

| 日誌類型 | 檔名格式 | 來源 |
|---------|---------|------|
| 安裝日誌 | `setup-YYYYMMDD-HHMMSS.log` | `setup.ps1` |
| Chrome 啟動日誌 | `launch-chrome-YYYYMMDD-HHMMSS.log` | `launch-chrome.ps1` |
| 素材蒐集日誌 | `collect-materials-YYYYMMDD-HHMMSS.log` | `collect-materials.ts` |

日誌行格式：`[YYYY-MM-DDTHH:mm:ss+08:00][INFO] emoji 訊息`  
層級為 `INFO` / `WARN` / `ERROR` / `CONTEXT`

每個日誌檔案開頭會自動記錄：
- 環境資訊（OS、Node.js 版本、Playwright 版本、CWD）
- 執行參數（命令列參數、設定檔內容）
- CDP 連接後所有頁面的 URL 與 `isUserPage` 狀態

### 12.5 metadata.json 欄位規格

`materials\metadata.json` 必含以下欄位（與 spec 一致）：

| 欄位 | 說明 |
|------|------|
| `projectName` | 專案名稱 |
| `collectedAt` | 蒐集完成時間（台北時間） |
| `timezone` | 固定為 `Asia/Taipei (UTC+8)` |
| `toolVersion` | 工具版本 |
| `platform` | 作業系統資訊 |
| `nodeVersion` | Node.js 版本 |
| `playwrightVersion` | Playwright 版本 |
| `logFile` | 本次蒐集對應的 log 檔名 |
| `totalPages` | 目標頁面總數 |
| `collectedPages` | 已蒐集頁面數 |
| `recordings` | 錄製檔清單 |
| `errors` | 錯誤記錄（含訊息與堆疊） |

> 時間戳記格式為 `YYYY-MM-DDTHH:mm:ss+08:00`，統一使用台北時間。

---

## 13. 指令速查表

### 安裝與啟動

| 指令 | 用途 | 何時使用 |
|------|------|---------|
| `.\setup.ps1` | 一鍵安裝所有依賴 | 第一次使用時 |
| `.\launch-chrome.ps1` | 啟動 Chrome Debug 模式 | 每次蒐集前 |

### 蒐集指令

| 指令 | 用途 | 使用場景 |
|------|------|---------|
| `npm run collect` | 互動式蒐集（推薦） | 第一次蒐集 |
| `npm run collect:auto` | 自動蒐集（依設定檔） | 批次蒐集多個頁面 |
| `npm run collect:snapshot` | 快速擷取當前頁面 | 臨時需要蒐集一個頁面 |
| `npm run collect:record` | 啟動 Codegen 錄製 | 錄製操作流程 |

### 進階參數

| 參數 | 說明 | 範例 |
|------|------|------|
| `--auto` | 自動模式（依設定檔） | `npx tsx collect-materials.ts --auto` |
| `--snapshot` | 快照模式（擷取當前頁面） | `npx tsx collect-materials.ts --snapshot` |
| `--record [name]` | 錄製模式（name 可選） | `npx tsx collect-materials.ts --record login-flow` |
| `--url <url>` | 錄製的起始網址（搭配 --record） | `npx tsx collect-materials.ts --record login --url http://site/login` |
| `--config <path>` | 指定設定檔（搭配 --auto） | `npx tsx collect-materials.ts --auto --config my-config.json` |
| `--port <port>` | 指定 CDP 端口（預設 9222） | `npx tsx collect-materials.ts --port 9223` |

### 設定檔欄位說明

| 欄位 | 類型 | 說明 |
|------|------|------|
| `projectName` | 字串 | 專案名稱 |
| `description` | 字串 | 專案描述 |
| `cdpPort` | 數字 | Chrome Debug 端口（預設 9222，範圍 1024-65535） |
| `outputDir` | 字串 | 輸出目錄（預設 `./materials`） |
| `collectOptions.ariaSnapshot` | 布林 | 是否蒐集 ARIA 快照（建議開啟） |
| `collectOptions.screenshot` | 布林 | 是否蒐集截圖 |
| `collectOptions.codegenRecording` | 布林 | 是否進行 Codegen 錄製 |
| `collectOptions.htmlSource` | 布林 | 是否蒐集 HTML 原始碼（預設關閉） |
| `collectOptions.iframeDepth` | 數字 | iframe 遞迴深度（預設 3，最大 10） |
| `pages` | 陣列 | 要蒐集的頁面清單 |
| `pages[].name` | 字串 | 頁面識別名稱（如 `01-login`） |
| `pages[].url` | 字串 | 頁面 URL |
| `pages[].description` | 字串 | 頁面描述 |
| `pages[].waitFor` | 字串 | 等待策略：`load` / `domcontentloaded` / `networkidle` / `commit` |
| `interactiveFlows` | 陣列 | 要錄製的互動流程 |
| `interactiveFlows[].name` | 字串 | 流程名稱 |
| `interactiveFlows[].startUrl` | 字串 | 起始 URL |

---

## 📝 版本記錄

| 版本 | 日期 | 變更內容 |
|------|------|---------|
| 1.2.0 | 2026-02-10 | 新增錄製檔密碼自動清理（sanitizeRecording）、錄製後自動擷取 ARIA 快照（extractUrlsFromRecording + captureSnapshotsForUrls）、Pre-commit Hook 指引（.githooks 啟用與掃描邏輯）、RECORDING_PASSWORD 環境變數設定說明 |
| 1.1.0 | 2026-02-10 | 已由 claude-opus-4.6 子代理更新：新增安全準則與憑證管理（§11）、CDP 連線原則與優雅關閉（§12）、更新前置條件（§3.1）、更新目錄編號、新增 metadata.json 時區說明、更新 .gitignore 包含 .env |
| 1.0.3 | 2026-02-09 | 修正 CDP 預存頁面無法操作問題（自動重新附加）、新增 Context7 MCP 設定、E2E 驗證通過 |
| 1.0.2 | 2026-02-09 | 修正 Chrome 內部頁面過濾（getActivePage）、強化端口衝突偵測、新增 spec.md/copilot-instructions.md/README.md |
| 1.0.1 | 2026-02-09 | 修正安裝腳本解析問題，新增完整日誌機制（logs/） |
| 1.0.0 | 2026-02-08 | 初版發布：完整的離線素材蒐集工具與指南（Windows 11 獨立離線包） |
