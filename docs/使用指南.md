# 🏗️ 內部網路網頁素材蒐集工具 — 使用指南

> **版本**：1.4.0
> **最後更新**：2026-02-12（新增 LLM 生成 Prompt 與 Debug Prompt 章節，強化非技術人員操作指引）
> **目標環境**：Windows 11 + PowerShell 7.x
> **目標讀者**：一般使用者（不需要程式設計經驗）

---

## 📋 目錄

1. [這個工具在做什麼？](#1-這個工具在做什麼)
2. [快速開始（Prereqs）](#2-快速開始prereqs)
3. [建立 .env 環境變數檔案](#3-建立-env-環境變數檔案)
4. [啟動 Chrome Debug 模式](#4-啟動-chrome-debug-模式)
5. [ARIA-first 互動式擷取（推薦）](#5-aria-first-互動式擷取推薦)
6. [錄製 Codegen 互動流程](#6-錄製-codegen-互動流程)
7. [其他蒐集模式](#7-其他蒐集模式)
8. [錄製後處理補抓（已停用的功能）](#8-錄製後處理補抓已停用的功能)
9. [啟用 Pre-commit Hook](#9-啟用-pre-commit-hook)
10. [檢查蒐集結果](#10-檢查蒐集結果)
11. [帶出素材到外網](#11-帶出素材到外網)
12. [用 AI 生成自動化腳本](#12-用-ai-生成自動化腳本)
13. [LLM 生成 Prompt：用素材生成 TypeScript 自動化腳本](#13-llm-生成-prompt用素材生成-typescript-自動化腳本)
14. [LLM Debug Prompt：除錯與修正自動化腳本](#14-llm-debug-prompt除錯與修正自動化腳本)
15. [範例：.env.example 與 Commit 訊息](#15-範例envexample-與-commit-訊息)
16. [Troubleshooting 故障排除](#16-troubleshooting-故障排除)
17. [指令速查表](#17-指令速查表)

---

## 1. 這個工具在做什麼？

### 用白話說

你要做的事情很簡單，就像「拍照 → 找設計師 → 裝潢」：

```
步驟一：在內部網路的電腦上「拍照」（蒐集網頁的結構資料）
    ↓
步驟二：把「照片」帶到有網路的地方
    ↓
步驟三：給 AI「設計師」看照片，請它幫你寫自動化腳本
    ↓
步驟四：把 AI 寫好的腳本帶回內部網路測試
```

### 蒐集的是什麼？

| 素材類型 | 用白話說 | 安全性 |
|---------|---------|--------|
| 📄 **ARIA 快照** | 網頁的「骨架圖」— 列出頁面上有什麼按鈕、表格、輸入框 | ✅ 安全（不含密碼或個資） |
| 📸 **截圖** | 網頁的「照片」— 讓你確認蒐集到的是正確頁面 | ⚠️ 需人工檢查有無個資 |
| 🎬 **錄製檔** | 操作的「動作記錄」— 記錄你按了哪些按鈕、點了哪裡 | ✅ 安全（已自動清理密碼） |

> 💡 **重點**：ARIA 快照是最重要的素材。AI 主要靠它來理解網頁結構。

---

## 2. 快速開始（Prereqs）

### 2.1 前置條件

你的電腦需要安裝：
- **Windows 11** + **PowerShell 7.x**（按 `Win + X` 開啟「終端機」即可）
- **Node.js v20 以上版本**
- **Google Chrome**

**怎麼確認有沒有安裝？**

1. 按 `Win + X`，選「終端機」或「PowerShell」
2. 輸入：`node --version`
3. 看到 `v20.x.x` 或更高版本即可

### 2.2 安裝工具依賴

**情境 A：電腦可以上網**

```powershell
cd C:\path\to\automation
.\setup.ps1
```

> ⚠️ 若出現「無法執行腳本」的錯誤，請先執行：
> ```powershell
> Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
> ```

**預期結果**：
```
  ✅ Node.js v22.x.x
  ✅ 程式庫安裝完成
  ✅ Playwright Chromium 安裝完成
  🎉 安裝完成！
```

**情境 B：電腦完全沒有網路（離線安裝）**

1. 先在有網路的電腦上執行 `setup.ps1`
2. 安裝完成後，把整個 `automation` 資料夾（**含 `node_modules` 資料夾**）複製到隨身碟
3. 把隨身碟帶到內網電腦，複製 `automation` 資料夾即可

> 📌 `node_modules` 資料夾約 200-300MB，離線環境必須帶著它。

**macOS / Linux**

```bash
cd /path/to/automation
npm run setup
```

```bash
# 離線模式（需要預先準備 node_modules 與 Playwright 瀏覽器）
npm run setup:offline
```

---

## 3. 建立 .env 環境變數檔案

### 為什麼需要 .env？

錄製互動流程時，工具會自動清理錄製檔中的密碼。`.env` 檔案讓你設定替換值和自動化腳本所需的憑證，**且不會被提交到 Git**。

### 建立步驟

1. 在 `automation` 資料夾下，複製 `.env.example` 為 `.env`（若沒有 `.env.example`，手動建立 `.env`）
2. 用記事本編輯 `.env`，填入你的值：

```env
# 內部網路網頁素材蒐集工具 — 環境變數
# ⚠️ 此檔案不可提交到 Git（已在 .gitignore 中排除）

# 錄製檔中密碼欄位的替換值
RECORDING_PASSWORD=

# 自動化腳本的憑證（若需要）
NCERT_USERNAME=
NCERT_PASSWORD=
```

> 🚨 **安全提醒**：`.env` 已在 `.gitignore` 中排除，不會被 Git 追蹤。請勿手動將它加入版本控制。

### .env 載入原理

程式啟動時會呼叫 `loadDotEnv()`：
- 若找到 `.env`，逐行讀取 `KEY=VALUE` 並設定到環境變數
- 若該 KEY 已經存在（例如已在 PowerShell 中設定），**不會覆蓋**
- 若找不到 `.env`，靜默跳過（不報錯）

---

## 4. 啟動 Chrome Debug 模式

### 為什麼需要這步？

蒐集工具需要「連接」到你的 Chrome 瀏覽器，才能讀取網頁的結構資料。

### 啟動步驟

**步驟一**：關閉所有正在運行的 Chrome 視窗

**步驟二**：

```powershell
cd C:\path\to\automation
.\launch-chrome.ps1
```

```bash
# macOS / Linux
cd /path/to/automation
./scripts/launch-chrome.sh
```

**預期結果**：
```
  ✅ Chrome Debug 模式已成功啟動！
  瀏覽器版本: Chrome/xxx.x.xxxx.xx
```

### 驗證成功

在 Chrome 網址列輸入：`http://localhost:9222/json/version`，看到 JSON 文字即成功。

### 登入你的內部網站

在 Debug Chrome 中前往內部網站並手動登入。工具會「看到」你在 Chrome 中的頁面。

> 📌 **CDP_PORT 預設 9222**。可用 `.\launch-chrome.ps1 -Port 9223` 自訂。

---

## 5. ARIA-first 互動式擷取（推薦）

### 為什麼叫 ARIA-first？

> 💡 **ARIA-first** 是本工具推薦的工作流程：**先擷取 ARIA 快照，再進行錄製**。
>
> 這麼做的原因是：錄製（Codegen）會開啟一個**獨立的瀏覽器視窗**，與你已登入的 Chrome 是**不同**的。如果反過來先錄製再補抓快照，補抓時可能因為沒有登入狀態而失敗。

### 操作步驟（一步一步跟著做）

**步驟一**：開啟 PowerShell（Chrome 的視窗不要關），執行：

```powershell
cd C:\path\to\automation
npm run collect
```

**步驟二**：選擇互動模式

```
請選擇蒐集模式：
[1] 📸 互動模式（推薦新手）
[2] 🤖 自動模式
[3] ⚡ 快照模式
[4] 🎬 錄製模式

請選擇 (1/2/3/4): 1
```

**步驟三**：輸入專案名稱（例如：`公文簽核系統`），按 Enter

**步驟四**：工具顯示當前 Chrome 頁面的資訊

**步驟五**：輸入頁面名稱（例如：`01-login-page`）和描述

**步驟六**：工具自動擷取 ARIA 快照 + 截圖

```
📸 擷取 ARIA 快照: 系統登入頁面
✅ 已儲存: 01-login-page.txt (2048 bytes)
📷 擷取截圖: 系統登入頁面
✅ 已儲存: 01-login-page.png (154320 bytes)
```

**步驟七**：選擇下一步動作

```
接下來要做什麼？
  [Enter] 繼續蒐集下一個頁面
  [r]     錄製互動流程 (codegen)
  [q]     結束蒐集
```

- **按 Enter**：在 Chrome 中先切換到下一個頁面，再回來按 Enter
- **按 r**：進入錄製模式（見第 6 節）
- **按 q**：結束蒐集，工具會儲存 metadata.json 和 summary-report.md

> 💡 **最佳實踐**：先把所有需要的頁面都用 ARIA 擷取完，最後再選 `r` 進行錄製。

---

## 6. 錄製 Codegen 互動流程

### 什麼時候需要錄製？

當你要記錄一段操作流程（例如：登入 → 填表 → 送出），讓 AI 了解操作步驟。

### 啟動方式

**方式 A**：在互動模式中選 `r`（推薦，因為你已經先擷取了 ARIA 快照）

**方式 B**：直接啟動錄製模式

```powershell
npm run collect:record
# 或指定名稱和 URL
npx tsx collect-materials.ts --record login-flow --url http://your-internal-site/login
```

### 錄製步驟

1. 工具會開啟一個**新的瀏覽器視窗**（不是你的 Chrome）
2. 在新視窗中操作你要錄製的流程
3. 完成後，**關閉瀏覽器視窗**即結束錄製

### 錄製完成後的自動流程

```
┌──────────────────────────────────────────┐
│  🎬 錄製完成！                            │
│  📄 login-flow.ts                        │
│  📦 12345 bytes                          │
│  🔒 敏感資訊已自動清理                    │
└──────────────────────────────────────────┘
```

工具會自動執行 `sanitizeRecording()`：
1. 掃描錄製檔中所有 `.fill()` 呼叫
2. 將密碼欄位的明文值替換為 `process.env.RECORDING_PASSWORD` 佔位符
3. 在檔案開頭加入清理標記：`// ⚠️ 此錄製檔已經過敏感資訊清理`

> ⚠️ **重要**：佔位符是字面上的 `process.env.RECORDING_PASSWORD`，不是密碼的實際值。錄製檔在執行時會動態讀取環境變數。

### UX 流程：關閉 Playwright

錄製開始前，CLI 會明確提示你：錄製將開啟一個新的瀏覽器視窗（Playwright Codegen），完成錄製後請先關閉該瀏覽器視窗，關閉後再回到本程式操作。

錄製視窗關閉並生成檔案後，工具會自動執行 sanitizeRecording() 做敏感資訊清理，然後顯示「錄製完成後的後續選單」，請依需求選擇：

  [Enter] 繼續蒐集下一個頁面
  [r]     重新錄製剛才的流程
  [a]     擷取目前活躍頁面的 ARIA 快照（若啟用）
  [q]     結束蒐集

此設計能避免使用者不確定錄製何時結束，並提供清晰的下一步指引。

---

## 7. 其他蒐集模式

### 7.1 快照模式（快速擷取當前頁面）

```powershell
npm run collect:snapshot
```

**使用場景**：你在操作過程中發現一個重要頁面，想趕快擷取下來。

### 7.2 自動模式（依設定檔批次蒐集）

先編輯 `collect-materials-config.json`，然後：

```powershell
npm run collect:auto
```

設定檔範例：

```json
{
  "projectName": "公文簽核系統",
  "cdpPort": 9222,
  "outputDir": "./materials",
  "collectOptions": {
    "ariaSnapshot": true,
    "screenshot": true,
    "codegenRecording": false,
    "htmlSource": false,
    "iframeDepth": 3
  },
  "pages": [
    {
      "name": "01-login",
      "url": "http://your-internal-site/login",
      "description": "登入頁面",
      "waitFor": "networkidle",
      "actions": []
    }
  ]
}
```

---

## 8. 錄製後處理補抓（已停用的功能）

### ⛔ 功能狀態：T-03 disabled

原本設計中，錄製完成後系統會自動解析錄製檔中的 `page.goto()` URL，然後逐一導航擷取 ARIA 快照。**此功能已被停用**。

### 停用原因

1. **Session 不共享**：Codegen 開啟的是獨立瀏覽器，與你的 Chrome 登入狀態不同
2. **頁面需要登入**：大多數內部網站頁面需要登入才能看到內容，自動導航會遇到登入頁面
3. **結果不可靠**：擷取到的快照可能是錯誤頁面或空頁面

### 如果你仍想嘗試

> ⚠️ **風險提醒**：以下方法僅適用於不需要登入的公開頁面。

1. 在程式碼中取消 T-03 的註解（`collect-materials.ts` 約 1149-1156 行）
2. 確保目標 URL 不需要登入即可存取
3. 執行錄製後，手動檢查產生的 ARIA 快照是否正確

**更好的替代方案**：使用 ARIA-first 工作流（第 5 節），在已登入的 Chrome 中逐頁擷取。

---

## 9. 啟用 Pre-commit Hook

### 為什麼需要 Pre-commit Hook？

錄製檔可能意外包含密碼等敏感資訊。Pre-commit Hook 會在你執行 `git commit` 時自動掃描，若發現可疑內容會阻止提交。

### 啟用步驟（一次性設定）

```powershell
cd C:\path\to\automation
git config core.hooksPath .githooks
```

### 驗證是否生效

```powershell
# 確認設定
git config core.hooksPath
# 預期輸出: .githooks

# 測試掃描（不實際 commit）
pwsh -File scripts\pre-commit-scan.ps1
```

### 當 Pre-commit 阻擋 Commit 時

如果你看到這樣的訊息：

```
❌ 敏感資訊偵測: login-flow.ts 匹配模式 [...]
🚫 commit 被阻止：錄製檔中偵測到疑似敏感資訊。
   請執行 sanitizeRecording 清理後再 commit。
```

**處理步驟**：

1. 打開被標記的錄製檔（例如 `materials\recordings\login-flow.ts`）
2. 搜尋 `.fill(` 找到含有明文值的行
3. 手動將明文值替換為 `process.env.RECORDING_PASSWORD`
4. 或者重新執行錄製（工具會自動清理）
5. 清理完成後重新 `git add` 和 `git commit`

### 暫時停用 Hook（不建議）

```powershell
git config --unset core.hooksPath
```

---

## 10. 檢查蒐集結果

### 確認素材目錄

```
materials\
├── aria-snapshots\           ← 最重要！AI 分析的核心素材
│   ├── 01-login-page.txt
│   └── 02-dashboard.txt
├── screenshots\              ← 視覺參考
│   ├── 01-login-page.png
│   └── 02-dashboard.png
├── recordings\               ← 操作流程記錄
│   └── login-flow.ts
├── metadata.json             ← 蒐集記錄
└── summary-report.md         ← 蒐集摘要報告
```

### 時區說明

> ⏰ 所有時間戳記統一使用**台北時間 Asia/Taipei (UTC+8)**。
> - 日誌行格式：`[2026-02-10T14:30:00+08:00][INFO] ...`
> - 檔名時間戳：`YYYYMMDD-HHmmss`（例如 `20260210-143000`）
> - metadata.json 的 `timezone` 欄位固定為 `Asia/Taipei (UTC+8)`

### 安全檢查

在帶出素材之前，請檢查：

| 檢查項目 | 怎麼檢查 | 處理方式 |
|---------|---------|---------|
| 錄製檔中有無明碼密碼 | 用記事本搜尋 `.fill(` | 替換為 `process.env.RECORDING_PASSWORD` |
| 截圖中有無個人資料 | 用眼睛看截圖 | 刪除含個資的截圖 |
| ARIA 快照中有無個資 | 用記事本搜尋 | 通常安全（ARIA 只記錄結構） |

---

## 11. 帶出素材到外網

### 最小攜出方案（最安全）

```powershell
# 只複製 ARIA 快照和錄製檔（核心素材）
Copy-Item -Recurse materials\aria-snapshots\ D:\USB\
Copy-Item -Recurse materials\recordings\ D:\USB\

# 選擇性攜出 metadata.json
Copy-Item materials\metadata.json D:\USB\
```

---

## 12. 用 AI 生成自動化腳本

在有網路的環境中，把 ARIA 快照和錄製檔交給 AI（ChatGPT、Claude、Copilot 等），請它生成 Playwright TypeScript 自動化腳本。

**關鍵提示**：
- 告知 AI 使用 `connectOverCDP` 連接（不是 `chromium.launch`）
- 告知 AI 不要呼叫 `browser.close()`
- 使用 ARIA 快照中的語意選擇器（`getByRole`、`getByLabel`）

---

## 13. LLM 生成 Prompt：用素材生成 TypeScript 自動化腳本

> 🎯 **本章目標**：提供一個可直接複製貼上到 ChatGPT / Claude / GPT 等大型語言模型的完整 prompt 範本，讓 AI 幫你生成可在內網環境執行的 TypeScript Playwright 自動化腳本。

### 13.1 事前準備（非技術人員一步一步操作）

在使用 LLM 之前，請先確認你已完成素材蒐集並備妥以下檔案：

| 步驟 | 動作 | 說明 |
|------|------|------|
| ① | 完成第 5～6 節的素材蒐集 | 取得 ARIA 快照、截圖、錄製檔 |
| ② | 完成第 10 節的安全檢查 | 確認錄製檔中無明碼密碼 |
| ③ | 完成第 11 節的素材帶出 | 將素材複製到有網路的電腦 |
| ④ | 開啟以下檔案備用 | 等下要貼到 LLM 對話中 |

**你需要準備的素材檔案清單**：

```
📁 你的素材資料夾
├── aria-snapshots\          ← 🔑 最重要！每一頁的 ARIA 快照 (.txt)
│   ├── 01-login-page.txt
│   ├── 02-dashboard.txt
│   └── 03-form-page.txt
├── recordings\              ← 🎬 操作錄製檔 (.ts)
│   └── login-flow.ts
├── screenshots\             ← 📷 截圖（可選，用於輔助 AI 理解）
│   ├── 01-login-page.png
│   └── 02-dashboard.png
└── metadata.json            ← 📋 蒐集環境資訊
```

**每個檔案的用途**：

| 檔案 | 代表什麼 | 必要性 |
|------|---------|--------|
| `aria-snapshots/*.txt` | 每個頁面的語意結構（按鈕、表格、輸入框位置） | ✅ 必要 |
| `recordings/*.ts` | 你的操作流程記錄（點了哪裡、輸入了什麼） | ✅ 必要（若有錄製） |
| `screenshots/*.png` | 頁面截圖（幫助 AI 理解視覺佈局） | ⭐ 建議 |
| `metadata.json` | 蒐集環境（Node 版本、Playwright 版本、OS） | ⭐ 建議 |

### 13.2 System Prompt（系統提示詞）

> 📋 **使用方式**：在 LLM 對話中，先設定以下「系統提示詞」（System Message）。若 LLM 不支援 System Message，可以在對話開頭先貼上這段。

將以下內容**完整複製**並貼到 LLM 的 System Message 欄位：

````markdown
## System Prompt — TypeScript Playwright 自動化腳本生成器

你是一位世界級的 TypeScript + Playwright 自動化腳本工程師。你的任務是根據使用者提供的「內部網路網頁素材」（ARIA 快照、截圖、Codegen 錄製檔、metadata）生成「可直接執行」的自動化腳本。

### 目標環境
- **OS**: Windows 11 + PowerShell 7.x（也相容 macOS / Linux）
- **Runtime**: Node.js v20+ / tsx（TypeScript 直接執行，無需編譯）
- **自動化引擎**: Playwright ^1.52.0
- **時區**: Asia/Taipei (UTC+8)
- **網路**: 腳本將在內部網路執行，不可依賴任何外部 CDN 或雲端 API

### 連接方式（Non-Negotiable）
- **MUST** 使用 `chromium.connectOverCDP('http://localhost:9222')` 連接到使用者已開啟的 Chrome Debug 模式
- **NEVER** 使用 `chromium.launch()` — 因為目標頁面需要使用者已登入的 session
- **NEVER** 呼叫 `browser.close()` — 這會關閉使用者正在操作的 Chrome
- 腳本結束時只需設定 `browser = null` 或直接結束程式，讓 Chrome 保持運行
- CDP_PORT 預設為 9222，但 MUST 支援透過環境變數 `CDP_PORT` 自訂

### 選擇器策略
- **優先使用 ARIA 語意選擇器**：`page.getByRole()`、`page.getByLabel()`、`page.getByText()`、`page.getByPlaceholder()`
- 參考提供的 ARIA 快照來決定最佳選擇器
- 避免使用脆弱的 CSS 選擇器（如 `.class-name`、`#id`），除非 ARIA 快照中找不到對應元素
- 若錄製檔中使用了 CSS 選擇器，盡可能改用 ARIA 語意選擇器

### 安全規範（Non-Negotiable）
- **NEVER** 在腳本中寫入明碼密碼 — 所有敏感值 MUST 透過 `process.env` 讀取
- 帳號使用 `process.env.NCERT_USERNAME`
- 密碼使用 `process.env.NCERT_PASSWORD`
- 其他敏感值以 `process.env.XXX` 形式處理
- 腳本開頭 MUST 檢查必要的環境變數是否已設定，若缺少則印出明確錯誤訊息並退出
- 腳本 MUST 載入 .env 檔案（使用內建的 loadDotEnv 函式或等效邏輯）

### 等待邏輯
- 優先使用 Playwright 內建等待：`page.waitForLoadState('networkidle')`
- 使用 `page.waitForSelector()` 等待特定元素出現
- 避免使用 `page.waitForTimeout()` 硬等待（除非沒有其他選項）
- 適當處理 SPA（Single Page Application）的非同步載入

### 錯誤處理
- 使用 try-catch-finally 結構包裹主邏輯
- finally 區塊中 MUST 只做清理（如設定 browser = null），NEVER 呼叫 browser.close()
- 錯誤發生時印出完整的錯誤訊息（含 stack trace）供除錯
- 使用 `process.exit(1)` 標記失敗

### 輸出格式要求
你的回覆 MUST 包含以下部分：
1. **完整可執行的 TypeScript 腳本**（使用 tsx 可直接執行的格式）
2. **執行說明**（如何在 PowerShell 中執行腳本）
3. **環境變數清單**（需要設定哪些 .env 變數）
4. **預期行為說明**（腳本會做什麼、產生什麼輸出）

### 腳本檔案命名
- 腳本檔名使用 kebab-case：`auto-login.ts`、`download-report.ts`
- 輸出資料檔案放到 `./output/` 目錄下
````

### 13.3 User Prompt 範本（使用者訊息模板）

> 📋 **使用方式**：將以下範本複製，把 `【...】` 佔位符替換為你的實際內容，然後貼到 LLM 對話中。

````markdown
## 我的需求

請根據以下素材，幫我生成一個 TypeScript + Playwright 自動化腳本。

### 任務描述
【用白話描述你要自動化的流程，例如：「自動登入公文簽核系統，然後下載今天的報表」】

### 環境資訊（來自 metadata.json）
- Node.js 版本：【例如：v24.13.0】
- Playwright 版本：【例如：1.58.2】
- 作業系統：【例如：win32-x64】
- CDP 連接埠：【預設 9222】

### ARIA 快照

#### 頁面 1：【頁面名稱，例如：登入頁面】
```
【貼上 aria-snapshots/01-login-page.txt 的完整內容】
```

#### 頁面 2：【頁面名稱，例如：儀表板】
```
【貼上 aria-snapshots/02-dashboard.txt 的完整內容】
```

（依此類推，每個頁面一個區塊）

### 錄製檔

#### 錄製：【流程名稱，例如：登入流程】
```typescript
【貼上 recordings/login-flow.ts 的完整內容】
```

### 截圖
（若 LLM 支援圖片上傳，可在此處上傳截圖；否則可省略此區塊）

### 額外說明
- 【任何特殊需求，例如：需要等待 5 秒讓頁面完全載入】
- 【目標頁面的 URL 格式，例如：http://192.168.1.100:8080/login】
- 【需要使用的帳號環境變數名稱，例如：NCERT_USERNAME / NCERT_PASSWORD】
````

### 13.4 非技術人員完整操作流程（一步一步）

以下是從準備素材到取得可執行腳本的完整步驟：

**第一步：開啟 LLM 對話**

在有網路的電腦上，打開瀏覽器前往以下任一 LLM：
- ChatGPT：`https://chatgpt.com`
- Claude：`https://claude.ai`
- 其他支援的 LLM

**第二步：貼上 System Prompt**

1. 找到 LLM 的「系統提示詞」設定（ChatGPT 在設定中，Claude 在專案設定中）
2. 將 [13.2 節](#132-system-prompt系統提示詞) 的完整內容複製貼上
3. 若 LLM 不支援 System Message，在對話最開頭先貼上，再加一行：`---`

**第三步：準備你的素材內容**

1. 用記事本打開 `metadata.json`，記下 Node.js 版本、Playwright 版本、作業系統
2. 用記事本打開每一個 `aria-snapshots\*.txt` 檔案
3. 用記事本打開 `recordings\*.ts` 檔案

**第四步：填寫並貼上 User Prompt**

1. 複製 [13.3 節](#133-user-prompt-範本使用者訊息模板) 的範本
2. 將所有 `【...】` 佔位符替換為你的實際內容
3. 貼到 LLM 對話中，按送出

**第五步：接收並儲存腳本**

1. LLM 會回覆一個完整的 TypeScript 腳本
2. 複製腳本內容，用記事本儲存為 `.ts` 檔案（例如：`auto-login.ts`）
3. 將檔案存放到你的 `automation` 資料夾中

**第六步：設定環境變數**

在 `automation` 資料夾下的 `.env` 檔案中，加入腳本所需的環境變數：

```env
# 自動化腳本所需的環境變數
NCERT_USERNAME=你的帳號
NCERT_PASSWORD=你的密碼
CDP_PORT=9222
```

> 🚨 **安全提醒**：
> - `.env` 檔案已在 `.gitignore` 中排除，不會被提交到 Git
> - **絕對不要**在 prompt 中包含你的實際密碼
> - **絕對不要**把 `.env` 檔案傳給任何人
> - 錄製檔中的密碼已被替換為 `process.env.RECORDING_PASSWORD` 佔位符

**第七步：執行腳本**

```powershell
# 1. 確保 Chrome Debug 模式已啟動
.\launch-chrome.ps1

# 2. 在 Chrome 中登入你的內部網站

# 3. 執行自動化腳本
npx tsx auto-login.ts
```

### 13.5 最小運作範例（快速驗證）

以下是一個不到 50 行的最小範例腳本，可用來驗證你的環境是否正確設定：

```typescript
// minimal-test.ts — 最小運作範例，驗證 CDP 連接是否正常
import { chromium } from 'playwright';
import * as fs from 'fs';
import * as path from 'path';

// 載入 .env
const envPath = path.join(process.cwd(), '.env');
if (fs.existsSync(envPath)) {
  fs.readFileSync(envPath, 'utf8').split(/\r?\n/).forEach(line => {
    const m = line.match(/^\s*([^#=]+?)\s*=\s*(.*)\s*$/);
    if (m && !process.env[m[1].trim()]) {
      let val = m[2].trim();
      if ((val.startsWith('"') && val.endsWith('"')) || (val.startsWith("'") && val.endsWith("'")))
        val = val.slice(1, -1);
      process.env[m[1].trim()] = val;
    }
  });
}

const CDP_PORT = process.env.CDP_PORT || '9222';

async function main() {
  console.log(`🔌 正在連接到 Chrome CDP (port ${CDP_PORT})...`);
  const browser = await chromium.connectOverCDP(`http://localhost:${CDP_PORT}`);
  console.log('✅ 連接成功！');

  const contexts = browser.contexts();
  console.log(`📄 找到 ${contexts.length} 個瀏覽器上下文`);

  for (const context of contexts) {
    const pages = context.pages();
    for (const page of pages) {
      const url = page.url();
      if (url.startsWith('chrome://') || url === 'about:blank') continue;
      const title = await page.title();
      console.log(`  🌐 ${title} — ${url}`);
    }
  }

  // ⚠️ 不呼叫 browser.close()，只讓程式自然結束
  console.log('🎉 驗證完成！你的環境已就緒。');
}

main().catch(err => {
  console.error('❌ 連接失敗:', err.message);
  process.exit(1);
});
```

**執行方式**：

```powershell
# 確保 Chrome Debug 模式已啟動
npx tsx minimal-test.ts
```

**預期輸出**：

```
🔌 正在連接到 Chrome CDP (port 9222)...
✅ 連接成功！
📄 找到 1 個瀏覽器上下文
  🌐 Example Domain — https://example.com/
🎉 驗證完成！你的環境已就緒。
```

### 13.6 LLM 回覆的預期結構

當 LLM 根據你的 prompt 產生回覆時，你應該會收到以下結構的內容：

```
📦 LLM 回覆內容
├── 1️⃣ 完整 TypeScript 腳本（可直接儲存為 .ts 檔案）
│   ├── import 語句
│   ├── loadDotEnv() 函式
│   ├── 環境變數檢查
│   ├── main() 主函式（含 connectOverCDP）
│   ├── 業務邏輯（根據你的需求）
│   └── 錯誤處理（try-catch-finally）
├── 2️⃣ 執行說明
│   ├── 所需環境變數清單
│   ├── .env 檔案範例
│   └── 執行指令（npx tsx script-name.ts）
├── 3️⃣ 預期行為與輸出
│   ├── 腳本會做什麼（步驟說明）
│   └── 輸出檔案位置（若有）
└── 4️⃣ 注意事項
    ├── 需要手動完成的步驟（如：先登入）
    └── 已知限制
```

---

## 14. LLM Debug Prompt：除錯與修正自動化腳本

> 🎯 **本章目標**：當 AI 生成的自動化腳本執行失敗時，提供一個可直接複製貼上到 LLM 的 debug prompt 範本，讓 AI 幫你找出問題原因並提供修正。

### 14.1 什麼時候需要用 Debug Prompt？

當你在執行 LLM 生成的腳本時，看到以下任一狀況：

- PowerShell 中出現紅色錯誤訊息
- 腳本執行後沒有產生預期結果
- 腳本執行到一半就停住或當掉
- 出現 `Error`、`TimeoutError`、`Cannot find element` 等字樣

### 14.2 Debug Prompt 範本

> 📋 **使用方式**：複製以下範本，將 `【...】` 佔位符替換為你的實際內容，然後貼到同一個 LLM 對話中（延續之前生成腳本的對話）。

````markdown
## 腳本執行失敗，請協助除錯

### 問題描述
【用白話描述發生了什麼，例如：「腳本執行到登入步驟後就報錯了」或「腳本跑完但沒有下載到檔案」】

### 錯誤訊息（完整複製 PowerShell 中的輸出）
```
【完整貼上 PowerShell 中顯示的錯誤訊息，包含所有 Error 和 stack trace】
```

### 執行環境
- Node.js 版本：【執行 `node --version` 的結果，例如：v24.13.0】
- Playwright 版本：【來自 metadata.json 或執行 `npx playwright --version`，例如：1.58.2】
- 作業系統：【例如：Windows 11 x64】
- TypeScript 執行器：tsx
- CDP 連接埠：【例如：9222】

### 當前腳本完整內容
```typescript
【貼上你目前的 .ts 腳本完整內容】
```

### 相關的 ARIA 快照（若與錯誤有關的頁面）
```
【貼上報錯時所在頁面的 ARIA 快照內容，例如 aria-snapshots/01-login-page.txt】
```

### 日誌檔案內容（若有）
```
【貼上 logs/ 目錄下最新的 .log 檔案中，與錯誤相關的部分】
```

### 補充資訊
- 【Chrome 是否以 Debug 模式啟動？是 / 否】
- 【是否已在 Chrome 中登入目標網站？是 / 否】
- 【.env 檔案中的環境變數是否已正確設定？是 / 否（不要貼出密碼的實際值！）】
- 【此腳本之前是否成功執行過？是 / 否】

### 我希望你提供
1. 清楚的錯誤原因分析（Root Cause）
2. 明確的修正步驟（步驟化說明）
3. 修正後的完整腳本或可直接套用的 patch
4. 若需更改 .env 設定，請列出需要改動的變數名稱與說明
````

### 14.3 非技術人員 Debug 操作流程（一步一步）

**第一步：收集錯誤資訊**

當腳本執行失敗時，PowerShell 視窗中會顯示錯誤訊息。**不要關閉視窗**，按以下步驟操作：

1. 用滑鼠**全選** PowerShell 中的輸出文字：
   - 在 PowerShell 視窗中按右鍵 → 「全選」
   - 或按 `Ctrl + A`
2. 按 `Ctrl + C` 複製
3. 打開記事本，按 `Ctrl + V` 貼上
4. 將內容暫存（等下要用）

**第二步：確認環境資訊**

在 PowerShell 中執行以下指令，並記下結果：

```powershell
# 查詢 Node.js 版本
node --version

# 查詢 Playwright 版本
npx playwright --version

# 查詢作業系統
[System.Environment]::OSVersion.VersionString
```

**第三步：找到相關素材**

1. 開啟出錯頁面對應的 ARIA 快照（在 `materials\aria-snapshots\` 目錄下）
2. 開啟最新的日誌檔案（在 `logs\` 目錄下，選最近日期的 `.log` 檔案）

**第四步：填寫並貼上 Debug Prompt**

1. 複製 [14.2 節](#142-debug-prompt-範本) 的範本
2. 將所有 `【...】` 佔位符替換為你的實際內容
3. **回到之前生成腳本的 LLM 對話**（這樣 AI 有完整上下文）
4. 貼上 Debug Prompt，按送出

> 🚨 **安全提醒**：
> - **絕對不要**在 Debug Prompt 中貼上 `.env` 檔案的實際內容
> - 如果錯誤訊息中意外包含密碼，請先用 `***` 取代再貼上
> - 只需告訴 AI「環境變數已設定」或「環境變數未設定」，不需要給出實際值

**第五步：接收並套用修正**

LLM 會回覆以下內容：

1. **錯誤原因分析（Root Cause）**：用白話解釋哪裡出了問題
2. **修正步驟**：一步一步告訴你怎麼改
3. **修正後的腳本或 Patch**：可能是以下兩種形式之一

   **形式 A — 完整替換腳本**：
   - 直接複製 LLM 回覆的完整腳本
   - 用記事本打開你的 `.ts` 檔案
   - 全選 → 刪除 → 貼上新內容 → 儲存

   **形式 B — Unified Diff Patch**（適合進階使用者）：
   ```diff
   --- a/auto-login.ts
   +++ b/auto-login.ts
   @@ -15,7 +15,7 @@
    async function main() {
      const browser = await chromium.connectOverCDP(`http://localhost:${CDP_PORT}`);
   -  const page = browser.contexts()[0].pages()[0];
   +  const page = browser.contexts()[0]?.pages()[0];
   +  if (!page) throw new Error('找不到已開啟的頁面，請確認 Chrome 中有開啟目標網站');
    }
   ```
   - 找到 `-` 開頭的行（要刪除的）
   - 找到 `+` 開頭的行（要新增的）
   - 在你的腳本中做對應修改

4. **環境設定變更**（若需要）：
   - LLM 會列出需要新增或修改的 `.env` 變數
   - 用記事本打開 `.env`，加入或修改對應的行

**第六步：重新執行腳本**

```powershell
npx tsx auto-login.ts
```

如果仍然失敗，重複第一步到第五步，再次將新的錯誤訊息貼給 LLM。

### 14.4 常見錯誤速查

| 錯誤訊息 | 可能原因 | 快速處理 |
|---------|---------|---------|
| `connect ECONNREFUSED 127.0.0.1:9222` | Chrome Debug 模式未啟動 | 執行 `.\launch-chrome.ps1` |
| `TimeoutError: page.waitForSelector` | 元素不存在或頁面未載入完成 | 確認已登入目標網站 |
| `Cannot find module 'playwright'` | Playwright 未安裝 | 執行 `.\setup.ps1` |
| `page.getByRole(...) is not a function` | Playwright 版本太舊 | 執行 `npm install playwright@latest` |
| `process.env.XXX is undefined` | 環境變數未設定 | 檢查 `.env` 檔案 |
| `net::ERR_CONNECTION_REFUSED` | 目標網站無法連線 | 確認內部網路可達 |
| `Target page, context or browser has been closed` | 連接中斷 | 重新啟動 Chrome Debug 並重新執行 |

### 14.5 進階：使用日誌檔案輔助除錯

本工具的日誌檔案（`logs\` 目錄下）包含完整的診斷資訊，非常適合交給 AI 分析。

**日誌包含的資訊**：
- 環境資訊（OS、Node.js 版本、Playwright 版本、CWD）
- 每個操作的時間戳記（台北時間 UTC+8）
- CDP 連接狀態（已連接的頁面清單）
- 錯誤的完整堆疊追蹤（stack trace）

**如何使用**：

```powershell
# 查看最新的日誌檔案
Get-ChildItem logs\ -Filter *.log | Sort-Object LastWriteTime -Descending | Select-Object -First 1
```

然後用記事本打開該 `.log` 檔案，將相關的錯誤段落貼到 Debug Prompt 中。

---

## 15. 範例：.env.example 與 Commit 訊息

### .env.example 範例

```env
# 內部網路網頁素材蒐集工具 — 環境變數範例
# 複製此檔案為 .env 並填入實際值
# ⚠️ .env 檔案不可提交到 Git

# 錄製檔中密碼欄位的替換值
RECORDING_PASSWORD=

# 自動化腳本憑證
NCERT_USERNAME=
NCERT_PASSWORD=
```

### Commit 訊息格式（可複製）

格式：`<type>(<scope>): <簡短摘要>`

| Type | 用途 | 範例 |
|------|------|------|
| `feat` | 新功能 | `feat(recording): 新增錄製檔自動清理功能` |
| `fix` | 錯誤修復 | `fix(core): 修正 CDP 預存頁面 URL 解析` |
| `docs` | 文件更新 | `docs(spec): 更新 ARIA-first 工作流說明` |
| `security` | 安全相關 | `security(hook): 新增 pre-commit 敏感資訊掃描` |
| `chore` | 雜項 | `chore(deps): 更新 Playwright 版本` |

**完整 Commit 範例**：

```
docs(spec,guide): 全面更新規格文件與使用指南

- 新增 ARIA-first 工作流說明（T-03 disabled 理由與替代方案）
- 修正 sanitizeRecording 方向說明（佔位符 vs 實際值）
- 新增 .env 使用指引與 .env.example 範例
- 新增 pre-commit hook 啟用與故障排除步驟
- 新增 API/Hook 列表（含 deprecated 標記）
- 更新時間戳格式規格（Asia/Taipei UTC+8）
```

---

## 16. Troubleshooting 故障排除

### 問題一：tsc 型別錯誤

**症狀**：執行 `npx tsc --noEmit` 出現 TypeScript 編譯錯誤。

**解決方式**：
1. 確認 `tsconfig.json` 的 `target` 和 `module` 設定正確
2. 執行 `npm install` 確保依賴完整
3. 若錯誤來自 `node_modules`，嘗試刪除後重裝：
   ```powershell
   Remove-Item -Recurse node_modules
   npm install
   ```

### 問題二：Pre-commit 被阻擋

**症狀**：`git commit` 時出現「❌ 敏感資訊偵測」。

**解決方式**：
1. 打開被標記的錄製檔
2. 搜尋 `.fill(` 或 `password`
3. 將明文值替換為 `process.env.RECORDING_PASSWORD`
4. `git add` 修改後的檔案
5. 重新 `git commit`

### 問題三：錄製檔內仍有明碼

**症狀**：`sanitizeRecording()` 執行後，檔案中仍可看到明文密碼。

**可能原因**：
- 密碼欄位的 selector 不匹配 sanitize 的正則表達式
- 密碼以雙引號而非單引號包裹

**解決方式**：
1. 手動打開錄製檔
2. 搜尋所有 `.fill(` 呼叫
3. 將含有密碼值的行手動替換：
   ```typescript
   // ❌ 修改前
   await page.locator('#password').fill('my-secret-password');
   // ✅ 修改後
   await page.locator('#password').fill(process.env.RECORDING_PASSWORD);
   ```
4. 執行 `pwsh -File scripts\pre-commit-scan.ps1` 驗證清理完成

### 問題四：Chrome Debug 連接失敗

**症狀**：「連接失敗」或「CDP 連接錯誤」。

**解決方式**：
1. 關閉所有 Chrome 視窗
2. 重新執行 `.\launch-chrome.ps1`
3. 確認 `http://localhost:9222/json/version` 可以訪問

### 問題五：端口 9222 已被佔用

**解決方式**：
1. 關閉所有 Chrome 後重新執行腳本
2. 或使用不同端口：`.\launch-chrome.ps1 -Port 9223`

### 問題六：PowerShell 無法執行 .ps1 腳本

**解決方式**：
```powershell
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser
```

### 問題七：Codegen 錄製失敗 / spawn EINVAL

**解決方式**：
1. 確認專案已更新到最新版本
2. 重新執行 `.\setup.ps1`
3. 手動測試：`npx playwright codegen --help`

### 問題八：選到 Chrome 內部頁面

**症狀**：找不到正確頁面，日誌出現 `chrome://` URL。

**解決方式**：確認 Chrome 中有開啟你的目標網站（不只是新分頁）。

### 問題九：Ctrl+C 後 metadata 沒有被儲存

**正常行為**：本工具已實作優雅關閉，按 Ctrl+C 後會自動儲存 metadata.json。若仍未儲存，可能是按了多次 Ctrl+C 強制終止。請只按一次 Ctrl+C。

---

## 17. 指令速查表

### 安裝與啟動

| 指令 | 用途 |
|------|------|
| `.\setup.ps1` | 一鍵安裝所有依賴 |
| `.\launch-chrome.ps1` | 啟動 Chrome Debug 模式 |
| `git config core.hooksPath .githooks` | 啟用 pre-commit hook |

### 蒐集指令

| 指令 | 用途 |
|------|------|
| `npm run collect` | 互動式蒐集（推薦） |
| `npm run collect:auto` | 自動蒐集（依設定檔） |
| `npm run collect:snapshot` | 快速擷取當前頁面 |
| `npm run collect:record` | 啟動 Codegen 錄製 |

### 進階參數

| 參數 | 說明 | 範例 |
|------|------|------|
| `--auto` | 自動模式 | `npx tsx collect-materials.ts --auto` |
| `--snapshot` | 快照模式 | `npx tsx collect-materials.ts --snapshot` |
| `--record [name]` | 錄製模式 | `npx tsx collect-materials.ts --record login-flow` |
| `--url <url>` | 錄製起始網址 | `--record login --url http://site/login` |
| `--port <port>` | 指定 CDP 端口 | `--port 9223` |
| `--config <path>` | 指定設定檔 | `--config my-config.json` |

### 安全相關

| 指令 | 用途 |
|------|------|
| `pwsh -File scripts\pre-commit-scan.ps1` | 手動掃描錄製檔 |
| `git config core.hooksPath .githooks` | 啟用 pre-commit hook |
| `git config --unset core.hooksPath` | 停用 pre-commit hook |

---

> 💬 遇到問題時，只要把 `logs\` 目錄下最新的 `.log` 檔案交給 AI，AI 就能精準分析出問題根因。
